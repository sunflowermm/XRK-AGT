# å·¥ä½œæµç³»ç»Ÿå®Œæ•´æ–‡æ¡£

## ğŸ“š ç›®å½•å¯¼èˆª

- [ç³»ç»Ÿæ¦‚è¿°](#ç³»ç»Ÿæ¦‚è¿°)
- [æ ¸å¿ƒæ¶æ„](#æ ¸å¿ƒæ¶æ„)
- [å·¥ä½œæµæ‰§è¡Œæµç¨‹](#å·¥ä½œæµæ‰§è¡Œæµç¨‹)
- [å·¥ä½œæµç®¡ç†å™¨è¯¦è§£](#å·¥ä½œæµç®¡ç†å™¨è¯¦è§£)
- [å·¥ä½œæµå¼€å‘æŒ‡å—](#å·¥ä½œæµå¼€å‘æŒ‡å—)
- [è®°å¿†ç³»ç»Ÿ](#è®°å¿†ç³»ç»Ÿ)
- [å·¥ä½œæµåˆå¹¶æœºåˆ¶](#å·¥ä½œæµåˆå¹¶æœºåˆ¶)
- [MCPå·¥å…·æ³¨å†Œ](#mcpå·¥å…·æ³¨å†Œ)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## ç³»ç»Ÿæ¦‚è¿°

XRK-AGTçš„å·¥ä½œæµç³»ç»Ÿæ˜¯ä¸€ä¸ª**æ™ºèƒ½ã€æ¨¡å—åŒ–ã€å¯æ‰©å±•**çš„å¤šæ­¥éª¤ä»»åŠ¡æ‰§è¡Œæ¡†æ¶ï¼Œæ”¯æŒï¼š

- âœ… **æ™ºèƒ½å†³ç­–**ï¼šè‡ªåŠ¨åˆ¤æ–­ä»»åŠ¡å¤æ‚åº¦ï¼Œå†³å®šæ˜¯å¦å¼€å¯å¤šæ­¥éª¤å·¥ä½œæµ
- âœ… **å·¥ä½œæµåˆå¹¶**ï¼šä¸»å·¥ä½œæµ+è¾…åŠ©å·¥ä½œæµçµæ´»ç»„åˆï¼Œåªåˆå¹¶åŠŸèƒ½ï¼Œä¸åˆå¹¶äººè®¾
- âœ… **ä¸Šä¸‹æ–‡ä¼ é€’**ï¼šè‡ªåŠ¨åœ¨æ­¥éª¤é—´ä¼ é€’æ‰§è¡Œç»“æœå’Œä¸Šä¸‹æ–‡
- âœ… **è®°å¿†ç³»ç»Ÿ**ï¼šæ¶ˆæ¯è®°å¿†ã€ç¬”è®°è®°å¿†ã€å·¥ä½œæµè®°å¿†ç»Ÿä¸€ä½¿ç”¨Rediså­˜å‚¨
- âœ… **å‡½æ•°è°ƒç”¨**ï¼šAIå¯ä»¥è°ƒç”¨æ³¨å†Œçš„å‡½æ•°ï¼Œæ‰§è¡Œç³»ç»Ÿæ“ä½œã€æ–‡ä»¶æ“ä½œç­‰

### æ ¸å¿ƒæ¦‚å¿µ

- **æ ¸å¿ƒå·¥ä½œæµ**ï¼šæä¾›ä¸»è¦åŠŸèƒ½ï¼ˆå¦‚ `desktop.js`ã€`chat.js`ï¼‰
- **è¾…åŠ©å·¥ä½œæµ**ï¼šä¸“é—¨æä¾›åŠŸèƒ½ç»™å…¶ä»–å·¥ä½œæµåˆå¹¶ä½¿ç”¨ï¼ˆå¦‚ `memory.js`ã€`database.js`ã€`todo.js`ï¼‰
- **å·¥ä½œæµç®¡ç†å™¨**ï¼šè´Ÿè´£å·¥ä½œæµçš„åˆ›å»ºã€æ‰§è¡Œå’ŒçŠ¶æ€ç®¡ç†ï¼ˆ`WorkflowManager`ï¼‰

---

## æ ¸å¿ƒæ¶æ„

### ç³»ç»Ÿæ¶æ„å›¾

```mermaid
flowchart TB
    subgraph User["ç”¨æˆ·è¯·æ±‚"]
        Request["ç”¨æˆ·æ¶ˆæ¯/è¯·æ±‚"]
    end

    subgraph Plugin["æ’ä»¶å±‚"]
        PluginCode["æ’ä»¶ä»£ç <br/>core/plugin/"]
    end

    subgraph StreamLoader["å·¥ä½œæµåŠ è½½å™¨"]
        LoadStreams["åŠ è½½å·¥ä½œæµ"]
        MergeStreams["åˆå¹¶å·¥ä½œæµ"]
        RegisterMCP["æ³¨å†ŒMCPæœåŠ¡"]
    end

    subgraph Workflows["å·¥ä½œæµå®ä¾‹"]
        ChatStream["chat.js<br/>èŠå¤©å·¥ä½œæµ"]
        DesktopStream["desktop.js<br/>æ¡Œé¢æ“ä½œå·¥ä½œæµ"]
        MemoryStream["memory.js<br/>è®°å¿†æ’ä»¶"]
        TodoStream["todo.js<br/>TODOæ’ä»¶"]
    end

    subgraph AIStream["AIStreamåŸºç±»"]
        Memory["è®°å¿†ç³»ç»Ÿ<br/>Rediså­˜å‚¨"]
        Embedding["Embeddingæ£€ç´¢"]
        FunctionCall["å‡½æ•°è°ƒç”¨è§£æ"]
        LLMCall["LLMè°ƒç”¨"]
    end

    subgraph WorkflowManager["å·¥ä½œæµç®¡ç†å™¨"]
        DecideMode["æ™ºèƒ½å†³ç­–<br/>decideWorkflowMode"]
        CreateWorkflow["åˆ›å»ºå·¥ä½œæµ<br/>createWorkflow"]
        ExecuteTodo["æ‰§è¡ŒTODO<br/>executeTodo"]
        Notes["ç¬”è®°ç³»ç»Ÿ"]
    end

    Request --> PluginCode
    PluginCode --> LoadStreams
    LoadStreams --> ChatStream
    LoadStreams --> DesktopStream
    LoadStreams --> MemoryStream
    LoadStreams --> TodoStream
    
    MergeStreams --> Memory
    MergeStreams --> Embedding
    
    ChatStream --> Memory
    DesktopStream --> Memory
    MemoryStream --> Memory
    
    Memory --> Embedding
    Embedding --> FunctionCall
    FunctionCall --> LLMCall
    
    TodoStream --> DecideMode
    DecideMode --> CreateWorkflow
    CreateWorkflow --> ExecuteTodo
    ExecuteTodo --> Notes
    
    style User fill:#E6F3FF
    style Plugin fill:#E6F3FF
    style StreamLoader fill:#FFE6CC
    style Workflows fill:#90EE90
    style AIStream fill:#87CEEB
    style WorkflowManager fill:#FFB6C1
```

### æ¶æ„å±‚æ¬¡

```mermaid
flowchart TB
    subgraph Business["ä¸šåŠ¡å±‚"]
        Custom["è‡ªå®šä¹‰å·¥ä½œæµ"]
        Logic["ä¸šåŠ¡é€»è¾‘"]
    end
    
    subgraph Workflow["å·¥ä½œæµå±‚"]
        Manager["WorkflowManager<br/>ä»»åŠ¡è§„åˆ’ä¸æ‰§è¡Œ"]
        Context["ä¸Šä¸‹æ–‡ç®¡ç†"]
    end
    
    subgraph Stream["æµå±‚"]
        Base["AIStreamåŸºç±»"]
        Functions["å‡½æ•°æ³¨å†Œä¸è§£æ"]
        Message["æ¶ˆæ¯å¤„ç†"]
    end
    
    subgraph Infra["åŸºç¡€è®¾æ–½å±‚"]
        Loader["StreamLoader"]
        LLM["LLMé›†æˆ"]
        Config["é…ç½®ç®¡ç†"]
    end
    
    Custom --> Manager
    Logic --> Manager
    Manager --> Context
    Context --> Base
    Base --> Functions
    Functions --> Message
    Message --> Loader
    Loader --> LLM
    LLM --> Config
    
    style Business fill:#E6F3FF
    style Workflow fill:#FFE6CC
    style Stream fill:#90EE90
    style Infra fill:#87CEEB
```

---

## å·¥ä½œæµæ‰§è¡Œæµç¨‹

### ç®€å•ä»»åŠ¡æµç¨‹

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant Plugin as æ’ä»¶
    participant Stream as å·¥ä½œæµ
    participant Context as ä¸Šä¸‹æ–‡å¢å¼º
    participant LLM as LLM
    participant Func as å‡½æ•°æ‰§è¡Œ

    User->>Plugin: å‘é€æ¶ˆæ¯
    Plugin->>Stream: process(e, question, options)
    Stream->>Stream: buildChatContext(e, question)
    Stream->>Context: buildEnhancedContext<br/>æ£€ç´¢å†å²+çŸ¥è¯†åº“
    Context-->>Stream: å¢å¼ºåçš„æ¶ˆæ¯æ•°ç»„
    Stream->>LLM: callAI(messages)
    LLM-->>Stream: å“åº”+å‡½æ•°è°ƒç”¨
    Stream->>Stream: parseFunctions(response)
    Stream->>Func: executeFunctionsWithReAct<br/>ReActæ¨¡å¼æ‰§è¡Œ
    Func-->>Stream: æ‰§è¡Œç»“æœ
    Stream->>Stream: storeMessageWithEmbedding<br/>å­˜å‚¨åˆ°è®°å¿†ç³»ç»Ÿ
    Stream-->>Plugin: è¿”å›cleanText
    Plugin-->>User: å›å¤æ¶ˆæ¯
```

### å¤æ‚ä»»åŠ¡æµç¨‹ï¼ˆTODOå·¥ä½œæµï¼‰

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant Plugin as æ’ä»¶
    participant Stream as å·¥ä½œæµ
    participant Manager as WorkflowManager
    participant LLM as LLM
    participant Func as å‡½æ•°æ‰§è¡Œ
    participant Notes as ç¬”è®°ç³»ç»Ÿ

    User->>Plugin: å‘é€å¤æ‚ä»»åŠ¡
    Plugin->>Stream: process(e, question, {enableTodo: true})
    Stream->>Stream: execute(e, question, config)
    Stream->>Stream: buildChatContext + buildEnhancedContext
    Stream->>LLM: callAIï¼ˆç¬¬1æ¬¡AIè°ƒç”¨ï¼‰
    LLM-->>Stream: å“åº”åŒ…å«[å¯åŠ¨å·¥ä½œæµ:ç›®æ ‡]
    Stream->>Stream: parseFunctions + hasWorkflowCommand
    Stream->>Manager: æ£€æµ‹åˆ°å·¥ä½œæµå‘½ä»¤
    Manager->>LLM: decideWorkflowModeï¼ˆç¬¬2æ¬¡AIè°ƒç”¨ï¼‰
    LLM-->>Manager: å¤æ‚ä»»åŠ¡ï¼Œéœ€è¦TODO
    Manager->>LLM: è§„åˆ’TODOåˆ—è¡¨ï¼ˆç¬¬3æ¬¡AIè°ƒç”¨ï¼‰
    LLM-->>Manager: TODOåˆ—è¡¨
    Manager->>Manager: createWorkflow()
    Manager-->>Stream: å·¥ä½œæµID
    
    loop æ‰§è¡Œæ¯ä¸ªTODO
        Manager->>Notes: è·å–å·¥ä½œæµç¬”è®°
        Notes-->>Manager: ç¬”è®°å†…å®¹
        Manager->>LLM: æ‰§è¡ŒTODOï¼ˆåŒ…å«ç¬”è®°ä¸Šä¸‹æ–‡ï¼‰
        LLM-->>Manager: æ‰§è¡Œè®¡åˆ’+å‡½æ•°è°ƒç”¨
        Manager->>Func: æ‰§è¡Œå‡½æ•°
        Func-->>Manager: æ‰§è¡Œç»“æœ
        Manager->>Notes: è®°å½•ç¬”è®°ï¼ˆå¦‚æœAIå†³å®šï¼‰
        Manager->>Manager: æ™ºèƒ½åˆ¤æ–­å®Œæˆåº¦
        alt æœªå®Œæˆ
            Manager->>Manager: ç»§ç»­ä¸‹ä¸€æ­¥
        else å·²å®Œæˆ
            Manager->>Manager: æ ‡è®°å®Œæˆ
        end
    end
    
    Manager->>LLM: ç”Ÿæˆå·¥ä½œæµæ€»ç»“ï¼ˆæ”¶å°¾AIè°ƒç”¨ï¼‰
    LLM-->>Manager: æ€»ç»“æ–‡æœ¬
    Manager-->>Stream: å·¥ä½œæµå®Œæˆ
    Stream-->>Plugin: è¿”å›ç»“æœ
    Plugin-->>User: å›å¤æ¶ˆæ¯
```

### å®Œæ•´æ‰§è¡Œæµç¨‹å›¾

```mermaid
flowchart TB
    A["ç”¨æˆ·è¯·æ±‚"] --> B["decideWorkflowMode<br/>åˆ¤æ–­æ˜¯å¦éœ€è¦å·¥ä½œæµ"]
    B --> C{"æ˜¯å¦éœ€è¦å·¥ä½œæµ"}
    C -->|æ˜¯| D["createWorkflow<br/>åˆ›å»ºå·¥ä½œæµ"]
    C -->|å¦| E["ç›´æ¥æ‰§è¡Œ"]
    D --> F["executeWorkflow<br/>æ‰§è¡Œå·¥ä½œæµå¾ªç¯"]
    F --> G["executeTodo<br/>æ‰§è¡Œå•ä¸ªä»»åŠ¡"]
    G --> H["buildTodoPrompt<br/>æ„å»ºä»»åŠ¡æç¤º"]
    H --> I["callAI<br/>è°ƒç”¨AI"]
    I --> J["parseAIResponse<br/>è§£æAIå“åº”"]
    J --> K["executeAction<br/>æ‰§è¡Œå‡½æ•°"]
    K --> L["calculateSmartCompletion<br/>æ™ºèƒ½åˆ¤æ–­å®Œæˆåº¦"]
    L --> M{"æ˜¯å¦å®Œæˆ"}
    M -->|å¦| G
    M -->|æ˜¯| N["å·¥ä½œæµå®Œæˆ"]
    E --> N
    
    style A fill:#E6F3FF
    style D fill:#FFE6CC
    style N fill:#90EE90
```

### AIè°ƒç”¨æ¬¡æ•°å’Œç”¨é€”

| è°ƒç”¨æ¬¡æ•° | ç”¨é€” | ä½¿ç”¨çš„Prompt | è¯´æ˜ |
|---------|------|-------------|------|
| ç¬¬1æ¬¡ | ç”¨æˆ·å¯¹è¯ï¼ŒAIå†³å®šå¯åŠ¨å·¥ä½œæµ | ä¸»streamçš„buildSystemPrompt + buildFunctionsPrompt + buildEnhancedContext | å¦‚æœAIè¾“å‡º[å¯åŠ¨å·¥ä½œæµ:ç›®æ ‡]ï¼Œåˆ™å¯åŠ¨TODOå·¥ä½œæµ |
| ç¬¬2æ¬¡ | ä»»åŠ¡åˆ†æåŠ©æ‰‹ï¼Œåˆ†æä»»åŠ¡å¹¶åˆ†è§£æ­¥éª¤ | ä»»åŠ¡åˆ†æåŠ©æ‰‹çš„ä¸“ç”¨prompt | åªåˆ†æï¼Œä¸æ‰§è¡Œï¼Œå“åº”ä¼šè¢«æ¸…ç† |
| ç¬¬3æ¬¡åŠä»¥å | æ¯ä¸ªTODOæ‰§è¡Œæ—¶ï¼ŒAIå†³å®šæ‰§è¡Œä»€ä¹ˆå‘½ä»¤ | ä¸»streamçš„buildSystemPrompt + buildFunctionsPrompt + å·¥ä½œæµç¬”è®° | åªè¾“å‡º[]æŒ‡ä»¤ï¼Œç³»ç»Ÿæ™ºèƒ½åˆ¤æ–­å®Œæˆåº¦ |
| æœ€å1æ¬¡ | å·¥ä½œæµå®Œæˆæ€»ç»“ | æ€»ç»“åŠ©æ‰‹çš„ä¸“ç”¨prompt | ç”Ÿæˆå·¥ä½œæµå®Œæˆæ€»ç»“ |

**æ³¨æ„**ï¼š
- ç®€å•ä»»åŠ¡ï¼ˆä¸éœ€è¦TODOï¼‰åªæœ‰ç¬¬1æ¬¡AIè°ƒç”¨
- å¤æ‚ä»»åŠ¡ï¼ˆéœ€è¦TODOï¼‰ä¼šæœ‰å¤šæ¬¡AIè°ƒç”¨
- `buildEnhancedContext`ä¼šè‡ªåŠ¨æ£€ç´¢å†å²å¯¹è¯å’ŒçŸ¥è¯†åº“ï¼Œå¢å¼ºä¸Šä¸‹æ–‡

---

## å·¥ä½œæµç®¡ç†å™¨è¯¦è§£

### WorkflowManageræ ¸å¿ƒåŠŸèƒ½

**ä½ç½®**: `core/workflow-manager.js`

**æ ¸å¿ƒèŒè´£**ï¼š
- å·¥ä½œæµçš„åˆ›å»ºã€æ‰§è¡Œå’Œç®¡ç†
- ä»»åŠ¡è§„åˆ’å’Œæ­¥éª¤åˆ†è§£
- ä¸Šä¸‹æ–‡åœ¨æ­¥éª¤é—´çš„ä¼ é€’
- çŠ¶æ€ç®¡ç†å’Œé”™è¯¯å¤„ç†

### å·¥ä½œæµçŠ¶æ€

```mermaid
stateDiagram-v2
    [*] --> PENDING: åˆ›å»ºå·¥ä½œæµ
    PENDING --> RUNNING: å¼€å§‹æ‰§è¡Œ
    RUNNING --> COMPLETED: æ‰€æœ‰TODOå®Œæˆ
    RUNNING --> FAILED: æ‰§è¡Œå¤±è´¥
    RUNNING --> PAUSED: æ‰‹åŠ¨æš‚åœ
    COMPLETED --> [*]
    FAILED --> [*]
    PAUSED --> RUNNING: æ¢å¤æ‰§è¡Œ
```

### å·¥ä½œæµå¯¹è±¡ç»“æ„

```javascript
{
  id: 'workflow_1234567890_abc123',
  goal: 'å¸®æˆ‘ä¾æ®æŠ¥å‘Š.docxåšä¸€ä¸ªè¡¨æ ¼',
  todos: [
    {
      id: 'todo_0',
      content: 'åœ¨æ¡Œé¢å·¥ä½œåŒºæŸ¥æ‰¾æŠ¥å‘Š.docxæ–‡ä»¶',
      status: 'pending',  // pending | in_progress | completed | failed
      result: null,
      error: null,
      notes: []
    }
  ],
  notes: [],  // å·¥ä½œæµç¬”è®°ï¼ˆ30åˆ†é’Ÿè¿‡æœŸï¼‰
  context: {  // ä¸Šä¸‹æ–‡ï¼Œåœ¨æ­¥éª¤é—´ä¼ é€’
    e: eventObject,
    fileContent: '...',
    commandOutput: '...'
  },
  iteration: 0,
  maxIterations: 20,
  status: 'running',  // pending | running | completed | failed | paused
  createdAt: 1703123456789,
  completedAt: null,
  debugSteps: [],  // è°ƒè¯•ä¿¡æ¯
  decisionSteps: []  // å†³ç­–é˜¶æ®µçš„AIè°ƒç”¨è®°å½•
}
```

### æ ¸å¿ƒæ–¹æ³•

#### 1. decideWorkflowMode - æ™ºèƒ½å†³ç­–

```mermaid
flowchart TB
    A["ç”¨æˆ·è¯·æ±‚"] --> B["æ£€æŸ¥æ˜¯å¦æœ‰è¿è¡Œä¸­çš„å·¥ä½œæµ"]
    B --> C{"å·²æœ‰å·¥ä½œæµ?"}
    C -->|æ˜¯| D["è¿”å›å·²æœ‰å·¥ä½œæµID"]
    C -->|å¦| E["è°ƒç”¨AIåˆ†æä»»åŠ¡å¤æ‚åº¦"]
    E --> F{"æ˜¯å¦éœ€è¦å·¥ä½œæµ"}
    F -->|å¦| G["è¿”å›ç®€å•ä»»åŠ¡"]
    F -->|æ˜¯| H["æå–TODOåˆ—è¡¨"]
    H --> I{"TODOåˆ—è¡¨ä¸ºç©º?"}
    I -->|æ˜¯| J["ç”Ÿæˆåˆå§‹TODO"]
    I -->|å¦| K["è¿”å›TODOåˆ—è¡¨"]
    J --> K
    D --> L["ç»“æŸ"]
    G --> L
    K --> L
    
    style E fill:#E6F3FF
    style H fill:#FFE6CC
    style K fill:#90EE90
```

**ä»£ç ç¤ºä¾‹**ï¼š
```javascript
const decision = await workflowManager.decideWorkflowMode(e, goal);

if (decision.shouldUseTodo && decision.todos.length > 0) {
  // å¤æ‚ä»»åŠ¡ï¼šå¯åŠ¨TODOå·¥ä½œæµ
  const workflowId = await workflowManager.createWorkflow(e, goal, decision.todos);
} else {
  // ç®€å•ä»»åŠ¡ï¼šç›´æ¥æ‰§è¡Œ
  await stream.process(e, { content: goal });
}
```

#### 2. createWorkflow - åˆ›å»ºå·¥ä½œæµ

```mermaid
flowchart TB
    A["createWorkflow"] --> B["æ¸…ç†å·²å®Œæˆçš„å·¥ä½œæµ"]
    B --> C["æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒå·¥ä½œæµ"]
    C --> D{"å·²å­˜åœ¨?"}
    D -->|æ˜¯| E["è¿”å›å·²æœ‰å·¥ä½œæµID"]
    D -->|å¦| F["åˆ›å»ºå·¥ä½œæµå¯¹è±¡"]
    F --> G["ä¿å­˜å·¥ä½œæµåˆ°å†…å­˜"]
    G --> H["å‘é€å·¥ä½œæµå¯åŠ¨æ¶ˆæ¯"]
    H --> I["å¼‚æ­¥å¯åŠ¨executeWorkflow"]
    I --> J["è¿”å›å·¥ä½œæµID"]
    E --> K["ç»“æŸ"]
    J --> K
    
    style F fill:#E6F3FF
    style I fill:#FFE6CC
```

#### 3. executeWorkflow - æ‰§è¡Œå·¥ä½œæµ

```mermaid
flowchart TB
    A["executeWorkflow"] --> B["è¿›å…¥å¾ªç¯"]
    B --> C{"æ‰€æœ‰TODOå®Œæˆ?"}
    C -->|æ˜¯| D["æ ‡è®°ä¸ºå®Œæˆ"]
    C -->|å¦| E["è·å–ä¸‹ä¸€ä¸ªå¾…æ‰§è¡Œçš„TODO"]
    E --> F{"TODOå­˜åœ¨?"}
    F -->|å¦| D
    F -->|æ˜¯| G["executeTodoæ‰§è¡ŒTODO"]
    G --> H["ç­‰å¾…STEP_DELAY"]
    H --> I{"è¾¾åˆ°æœ€å¤§è¿­ä»£æ¬¡æ•°?"}
    I -->|æ˜¯| J["æ ‡è®°ä¸ºå¤±è´¥"]
    I -->|å¦| B
    D --> K["ç”Ÿæˆå·¥ä½œæµæ€»ç»“"]
    J --> L["ç»“æŸ"]
    K --> L
    
    style G fill:#E6F3FF
    style K fill:#FFE6CC
```

#### 4. processTodo - å¤„ç†å•ä¸ªTODO

```mermaid
flowchart TB
    A["processTodo"] --> B["å‡†å¤‡ä¸Šä¸‹æ–‡å’Œæç¤º"]
    B --> C["è°ƒç”¨AIè·å–æ‰§è¡ŒæŒ‡ä»¤"]
    C --> D["è§£æAIå“åº”"]
    D --> E["è®°å½•å†å²"]
    E --> F["æ‰§è¡Œæ‰€æœ‰æå–çš„æŒ‡ä»¤"]
    F --> G["æ™ºèƒ½åˆ¤æ–­å®Œæˆåº¦"]
    G --> H["åˆå¹¶ä¸Šä¸‹æ–‡"]
    H --> I["å‘é€æµç¨‹å›å¤"]
    I --> J["å‘é€è‡ªç„¶è¯­è¨€å›å¤"]
    J --> K["è®°å½•è°ƒè¯•ä¿¡æ¯"]
    K --> L["æ›´æ–°TODOçŠ¶æ€"]
    
    style C fill:#E6F3FF
    style F fill:#FFE6CC
    style G fill:#90EE90
```
<ï½œtoolâ–callsâ–beginï½œ><ï½œtoolâ–callâ–beginï½œ>
read_file

**è¯¦ç»†æ­¥éª¤**ï¼š
1. **å‡†å¤‡ä¸Šä¸‹æ–‡å’Œæç¤º**ï¼šè·å–å·¥ä½œæµç¬”è®°ï¼Œæ„å»ºTODOæç¤º
2. **è°ƒç”¨AIè·å–æ‰§è¡ŒæŒ‡ä»¤**ï¼šä½¿ç”¨ä¸»streamçš„promptï¼Œåˆå¹¶æ‰€æœ‰streamçš„functions
3. **è§£æAIå“åº”**ï¼šæå–[]æŒ‡ä»¤ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰[å®Œæˆ]æŒ‡ä»¤
4. **æ‰§è¡Œæ‰€æœ‰æå–çš„æŒ‡ä»¤**ï¼šé¡ºåºæ‰§è¡Œæ‰€æœ‰å‡½æ•°
5. **æ™ºèƒ½åˆ¤æ–­å®Œæˆåº¦**ï¼šåŸºäºæ‰§è¡Œç»“æœã€ä¸Šä¸‹æ–‡ã€å®ŒæˆæŒ‡ä»¤ç­‰
6. **åˆå¹¶ä¸Šä¸‹æ–‡**ï¼šå°†æ‰§è¡Œç»“æœåˆå¹¶åˆ°workflow.context
7. **å‘é€æµç¨‹å›å¤**ï¼šå‘é€æ ‡å‡†åŒ–çš„JSONæ ¼å¼å›å¤
8. **å‘é€è‡ªç„¶è¯­è¨€å›å¤**ï¼šæå–AIçš„è‡ªç„¶è¯­è¨€å›å¤å¹¶å‘é€
9. **è®°å½•è°ƒè¯•ä¿¡æ¯**ï¼šä¿å­˜å®Œæ•´çš„æ‰§è¡Œæ—¥å¿—

#### 5. æ™ºèƒ½å®Œæˆåº¦åˆ¤æ–­

```mermaid
flowchart TB
    A["calculateSmartCompletion"] --> B{"AIè¾“å‡ºäº†å®ŒæˆæŒ‡ä»¤?"}
    B -->|æ˜¯| C["è¿”å›1.0"]
    B -->|å¦| D["æ£€æŸ¥ä¸Šä¸‹æ–‡æ˜¯å¦æ˜¾ç¤ºä»»åŠ¡å·²å®Œæˆ"]
    D --> E{"ä¸Šä¸‹æ–‡æ˜¾ç¤ºå·²å®Œæˆ?"}
    E -->|æ˜¯| F["è¿”å›0.85-1.0"]
    E -->|å¦| G{"æ‰§è¡ŒæˆåŠŸä¸”æ²¡æœ‰é”™è¯¯?"}
    G -->|æ˜¯| H["è¿”å›0.8-0.9"]
    G -->|å¦| I{"æœ‰æ‰§è¡Œä½†å¤±è´¥?"}
    I -->|æ˜¯| J["è¿”å›0.3"]
    I -->|å¦| K{"æœ‰æ‰§è¡Œä½†éƒ¨åˆ†æˆåŠŸ?"}
    K -->|æ˜¯| L["æ ¹æ®æˆåŠŸç‡è®¡ç®—0.3-0.9"]
    K -->|å¦| M{"AIè¾“å‡ºäº†æŒ‡ä»¤ä½†æœªæ‰§è¡Œ?"}
    M -->|æ˜¯| N["è¿”å›0.5"]
    M -->|å¦| O["è¿”å›0.6"]
    
    style C fill:#90EE90
    style F fill:#90EE90
    style H fill:#87CEEB
    style J fill:#FF6B6B
```

**å®Œæˆåº¦é˜ˆå€¼**ï¼š
- `COMPLETION_THRESHOLD: 0.8` - è¾¾åˆ°æ­¤å€¼æ ‡è®°ä¸ºå®Œæˆ
- `PROGRESS_THRESHOLD: 0.5` - è¾¾åˆ°æ­¤å€¼æ ‡è®°ä¸ºè¿›è¡Œä¸­

---

## æ ¸å¿ƒæ–¹æ³•è¯¦è§£

### execute æ–¹æ³•

**ç­¾å**ï¼š`async execute(e, question, config)`

**åŠŸèƒ½**ï¼šæ‰§è¡Œå·¥ä½œæµçš„æ ¸å¿ƒæ–¹æ³•ï¼ŒåŒ…å«å®Œæ•´çš„AIè°ƒç”¨ã€å‡½æ•°æ‰§è¡Œã€ä¸Šä¸‹æ–‡å¢å¼ºæµç¨‹ã€‚

**å‚æ•°**ï¼š
- `e`: äº‹ä»¶å¯¹è±¡ï¼ˆå¯é€‰ï¼‰
- `question`: ç”¨æˆ·é—®é¢˜ï¼ˆå­—ç¬¦ä¸²æˆ–å¯¹è±¡ `{content: string, text: string}`ï¼‰
- `config`: LLMé…ç½®å¯¹è±¡ï¼ˆå¯é€‰ï¼Œä¼šä¸ `this.config` åˆå¹¶ï¼‰

**æ‰§è¡Œæµç¨‹**ï¼š
1. æ„å»ºåŸºç¡€ä¸Šä¸‹æ–‡ï¼š`buildChatContext(e, question)`
2. å¢å¼ºä¸Šä¸‹æ–‡ï¼š`buildEnhancedContext(e, question, baseMessages)` - è‡ªåŠ¨æ£€ç´¢å†å²å¯¹è¯å’ŒçŸ¥è¯†åº“
3. è°ƒç”¨AIï¼š`callAI(messages, config)`
4. è§£æå‡½æ•°ï¼š`parseFunctions(response, context)`
5. å‘é€è‡ªç„¶è¯­è¨€å›å¤ï¼ˆå¦‚æœæœ‰ï¼‰
6. æ‰§è¡Œå‡½æ•°ï¼š`executeFunctionsWithReAct(functions, context, question)` - ä½¿ç”¨ReActæ¨¡å¼
7. å­˜å‚¨åˆ°è®°å¿†ç³»ç»Ÿï¼š`storeMessageWithEmbedding(groupId, message)`
8. è¿”å›æ¸…æ´—åçš„æ–‡æœ¬ `cleanText`

**è¿”å›å€¼**ï¼š`Promise<string|null>` - æ¸…æ´—åçš„AIå›å¤æ–‡æœ¬

### process æ–¹æ³•

**ç­¾å**ï¼š`async process(e, question, options = {})`

**åŠŸèƒ½**ï¼šå·¥ä½œæµå¤„ç†çš„ç®€åŒ–å…¥å£ï¼Œæ”¯æŒå·¥ä½œæµåˆå¹¶ã€TODOå†³ç­–ã€è®°å¿†ç³»ç»Ÿç­‰é«˜çº§åŠŸèƒ½ã€‚

**å‚æ•°**ï¼š
- `e`: äº‹ä»¶å¯¹è±¡
- `question`: ç”¨æˆ·é—®é¢˜ï¼ˆå­—ç¬¦ä¸²æˆ–å¯¹è±¡ï¼‰
- `options`: å¤„ç†é€‰é¡¹å¯¹è±¡
  - `mergeStreams`: `Array<string>` - è¦åˆå¹¶çš„å·¥ä½œæµåç§°åˆ—è¡¨ï¼ˆå¦‚ `['desktop', 'tools']`ï¼‰
  - `enableTodo`: `boolean` - æ˜¯å¦å¯ç”¨TODOæ™ºèƒ½å†³ç­–ï¼ˆé»˜è®¤ `false`ï¼‰
  - `enableMemory`: `boolean` - æ˜¯å¦å¯ç”¨è®°å¿†ç³»ç»Ÿï¼ˆé»˜è®¤ `false`ï¼‰
  - `enableDatabase`: `boolean` - æ˜¯å¦å¯ç”¨çŸ¥è¯†åº“ç³»ç»Ÿï¼ˆé»˜è®¤ `false`ï¼‰
  - `apiConfig`: `Object` - LLMé…ç½®ï¼ˆå¯é€‰ï¼Œä¼šä¸ `this.config` åˆå¹¶ï¼‰

**æ‰§è¡Œæµç¨‹**ï¼š
1. è‡ªåŠ¨åˆå¹¶è¾…åŠ©å·¥ä½œæµï¼ˆå¦‚æœå¯ç”¨ `enableMemory` æˆ– `enableDatabase`ï¼‰
2. åˆå¹¶æŒ‡å®šå·¥ä½œæµï¼ˆå¦‚æœæä¾› `mergeStreams`ï¼‰
3. è°ƒç”¨ `execute(e, question, apiConfig)` æ‰§è¡Œå·¥ä½œæµ
4. æ£€æŸ¥æ˜¯å¦éœ€è¦å¯åŠ¨TODOå·¥ä½œæµï¼ˆå¦‚æœå¯ç”¨ `enableTodo` ä¸”AIè¾“å‡ºäº†å·¥ä½œæµå‘½ä»¤ï¼‰

**è¿”å›å€¼**ï¼š`Promise<string|null>` - AIå›å¤æ–‡æœ¬

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```javascript
// ç®€å•è°ƒç”¨
await stream.process(e, question);

// å¯ç”¨è®°å¿†å’ŒçŸ¥è¯†åº“
await stream.process(e, question, {
  enableMemory: true,
  enableDatabase: true
});

// åˆå¹¶å·¥ä½œæµå¹¶å¯ç”¨TODO
await stream.process(e, question, {
  mergeStreams: ['desktop', 'tools'],
  enableTodo: true,
  enableMemory: true
});
```

### buildEnhancedContext æ–¹æ³•

**ç­¾å**ï¼š`async buildEnhancedContext(e, question, baseMessages)`

**åŠŸèƒ½**ï¼šæ„å»ºå¢å¼ºä¸Šä¸‹æ–‡ï¼ˆRAGæµç¨‹ï¼‰ï¼Œè‡ªåŠ¨æ£€ç´¢å†å²å¯¹è¯å’ŒçŸ¥è¯†åº“ï¼Œå¢å¼ºAIçš„ä¸Šä¸‹æ–‡ç†è§£èƒ½åŠ›ã€‚

**æ‰§è¡Œæµç¨‹**ï¼š
1. æå–æŸ¥è¯¢æ–‡æœ¬ï¼ˆä» `question` æˆ– `baseMessages` ä¸­æå–ï¼‰
2. æ£€ç´¢å†å²å¯¹è¯ä¸Šä¸‹æ–‡ï¼š`retrieveRelevantContexts(groupId, query)` - ä½¿ç”¨Embeddingç›¸ä¼¼åº¦æ£€ç´¢
3. æ£€ç´¢çŸ¥è¯†åº“ä¸Šä¸‹æ–‡ï¼š`retrieveKnowledgeContexts(query)` - è‡ªåŠ¨é›†æˆdatabase stream
4. åˆå¹¶æ‰€æœ‰ä¸Šä¸‹æ–‡ï¼ˆå†å²å¯¹è¯ + çŸ¥è¯†åº“ï¼‰
5. ä½¿ç”¨æ³¨æ„åŠ›æœºåˆ¶ä¼˜åŒ–ä¸Šä¸‹æ–‡ï¼š`optimizeContextsWithAttention(contexts, query, maxTokens)`
6. æ„å»ºä¸Šä¸‹æ–‡æç¤ºè¯ï¼Œé™„åŠ åˆ° `baseMessages` å¼€å¤´

**è¿”å›å€¼**ï¼š`Promise<Array>` - å¢å¼ºåçš„æ¶ˆæ¯æ•°ç»„

**æ³¨æ„**ï¼š
- åªæœ‰åœ¨ `embeddingConfig.enabled === true` ä¸” `embeddingReady === true` æ—¶æ‰ä¼šæ£€ç´¢å†å²å¯¹è¯
- çŸ¥è¯†åº“æ£€ç´¢ä¼šè‡ªåŠ¨æ£€æŸ¥æ˜¯å¦æœ‰åˆå¹¶çš„ `database` stream
- ä¸Šä¸‹æ–‡ä¼˜åŒ–ä½¿ç”¨æ³¨æ„åŠ›æœºåˆ¶ï¼Œè‡ªåŠ¨é€‰æ‹©æœ€ç›¸å…³çš„ä¸Šä¸‹æ–‡

---

## å·¥ä½œæµå¼€å‘æŒ‡å—

### å¿«é€Ÿå¼€å§‹

**å·¥ä½œæµå¼€å‘æµç¨‹**:

```mermaid
flowchart TB
    A["åˆ›å»ºAIStreamå­ç±»"] --> B["å®šä¹‰æ„é€ å‡½æ•°<br/>é…ç½®name/descriptionç­‰"]
    B --> C["å®ç°initæ–¹æ³•<br/>è°ƒç”¨super.init"]
    C --> D["æ³¨å†Œå‡½æ•°<br/>registerFunction"]
    D --> E["å¯é€‰ï¼šå®ç°buildSystemPrompt<br/>æ„å»ºç³»ç»Ÿæç¤ºè¯"]
    E --> F["å¯é€‰ï¼šå®ç°buildChatContext<br/>æ„å»ºèŠå¤©ä¸Šä¸‹æ–‡"]
    F --> G["å·¥ä½œæµå¯ç”¨"]
    
    style A fill:#E6F3FF
    style D fill:#FFE6CC
    style G fill:#90EE90
```

### åˆ›å»ºæ ¸å¿ƒå·¥ä½œæµ

```javascript
// core/stream/my-core.js
import AIStream from '#infrastructure/aistream/aistream.js';

export default class MyCoreStream extends AIStream {
  constructor() {
    super({
      name: 'my-core',
      description: 'æˆ‘çš„æ ¸å¿ƒå·¥ä½œæµ',
      priority: 100,  // æ ¸å¿ƒå·¥ä½œæµä¼˜å…ˆçº§è¾ƒé«˜
      config: {
        enabled: true,
        temperature: 0.8,
        maxTokens: 6000
      }
    });
  }

  async init() {
    await super.init();
    this.registerAllFunctions();
  }

  registerAllFunctions() {
    // æ³¨å†Œæ ¸å¿ƒåŠŸèƒ½
    this.registerFunction('core_function', {
      description: 'æ ¸å¿ƒåŠŸèƒ½',
      prompt: `[æ ¸å¿ƒåŠŸèƒ½:å‚æ•°] - æ ¸å¿ƒåŠŸèƒ½æè¿°`,
      parser: (text, context) => {
        const functions = [];
        const reg = /\[æ ¸å¿ƒåŠŸèƒ½:([^\]]+)\]/g;
        let match;
        while ((match = reg.exec(text)) !== null) {
          functions.push({ 
            type: 'core_function', 
            params: { param: match[1].trim() } 
          });
        }
        return { 
          functions, 
          cleanText: text.replace(reg, '').trim() 
        };
      },
      handler: async (params, context) => {
        const { param } = params || {};
        // å¤„ç†é€»è¾‘
      },
      enabled: true
    });
  }

  // å¯é€‰å®ç°ï¼šæ„å»ºç³»ç»Ÿæç¤ºè¯ï¼ˆå¦‚æœæœªå®ç°ï¼ŒåŸºç±»è¿”å›ç©ºå­—ç¬¦ä¸²ï¼‰
  buildSystemPrompt(context) {
    return `ã€äººè®¾ã€‘
ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½åŠ©æ‰‹ã€‚

ã€æ ¸å¿ƒåŠŸèƒ½ã€‘
${this.buildFunctionsPrompt()}`;
  }

  // å¯é€‰å®ç°ï¼šæ„å»ºèŠå¤©ä¸Šä¸‹æ–‡ï¼ˆå¦‚æœæœªå®ç°ï¼ŒåŸºç±»è¿”å›ç©ºæ•°ç»„ï¼‰
  async buildChatContext(e, question) {
    return [];
  }
}
```

### åˆ›å»ºè¾…åŠ©å·¥ä½œæµ

```javascript
// core/stream/my-auxiliary.js
import AIStream from '#infrastructure/aistream/aistream.js';

export default class MyAuxiliaryStream extends AIStream {
  constructor() {
    super({
      name: 'my-auxiliary',
      description: 'æˆ‘çš„è¾…åŠ©å·¥ä½œæµ',
      priority: 1,  // è¾…åŠ©å·¥ä½œæµä¼˜å…ˆçº§è¾ƒä½
      config: {
        enabled: true,
        temperature: 0.7,
        maxTokens: 4000
      },
      embedding: { enabled: false }
    });
  }

  async init() {
    await super.init();
    this.registerAllFunctions();
  }

  registerAllFunctions() {
    // åŠ¨æ€è·å–è¾…åŠ©ä¿¡æ¯
    const getAuxiliaryInfo = () => {
      const info = this.getSomeInfo();
      return info ? `\nå½“å‰ä¿¡æ¯ï¼š${info}` : '';
    };

    // æ³¨å†Œå‡½æ•°ï¼ˆä½¿ç”¨åŠ¨æ€promptï¼‰
    this.registerFunction('my_function', {
      description: 'æˆ‘çš„åŠŸèƒ½',
      prompt: () => `[æˆ‘çš„åŠŸèƒ½:å‚æ•°] - åŠŸèƒ½æè¿°${getAuxiliaryInfo()}`,
      parser: (text, context) => {
        const match = text.match(/\[æˆ‘çš„åŠŸèƒ½:([^\]]+)\]/);
        if (!match) {
          return { functions: [], cleanText: text };
        }
        return {
          functions: [{ type: 'my_function', params: { param: match[1] } }],
          cleanText: text.replace(/\[æˆ‘çš„åŠŸèƒ½:[^\]]+\]/g, '').trim()
        };
      },
      handler: async (params, context) => {
        const { param } = params || {};
        // å¤„ç†é€»è¾‘
      },
      enabled: true
    });
  }

  /**
   * æ„å»ºç³»ç»Ÿæç¤ºï¼ˆå¯é€‰å®ç°ï¼Œè¾…åŠ©å·¥ä½œæµåˆå¹¶æ—¶ä¸ä¼šè¢«è°ƒç”¨ï¼‰
   * åªæœ‰ä¸»å·¥ä½œæµçš„buildSystemPromptä¼šè¢«ä½¿ç”¨
   * å¦‚æœæœªå®ç°ï¼ŒåŸºç±»ä¼šè¿”å›ç©ºå­—ç¬¦ä¸²
   */
  buildSystemPrompt(context) {
    return 'æˆ‘çš„è¾…åŠ©å·¥ä½œæµæ’ä»¶ï¼Œä¸ºå…¶ä»–å·¥ä½œæµæä¾›åŠŸèƒ½ã€‚';
  }

  /**
   * æ„å»ºèŠå¤©ä¸Šä¸‹æ–‡ï¼ˆå¯é€‰å®ç°ï¼‰
   * å¦‚æœæœªå®ç°ï¼ŒåŸºç±»ä¼šè¿”å›ç©ºæ•°ç»„
   */
  async buildChatContext(e, question) {
    return [];
  }
}
```

### å‡½æ•°æ³¨å†Œè¯¦è§£

å‡½æ•°æ˜¯å·¥ä½œæµçš„åŸºæœ¬æ‰§è¡Œå•å…ƒï¼Œæ¯ä¸ªå‡½æ•°åŒ…å«ï¼š

- `description`: å‡½æ•°æè¿°
- `prompt`: ç”¨æˆ·å¯è§çš„å‘½ä»¤æ ¼å¼ï¼ˆæ”¯æŒå­—ç¬¦ä¸²æˆ–å‡½æ•°ç±»å‹ï¼‰
- `parser`: è§£ææ–‡æœ¬ä¸­çš„å‡½æ•°è°ƒç”¨
- `handler`: æ‰§è¡Œå‡½æ•°é€»è¾‘
- `enabled`: æ˜¯å¦å¯ç”¨
- `onlyTopLevel`: æ˜¯å¦ä»…å…è®¸é¡¶å±‚è°ƒç”¨ï¼ˆå·¥ä½œæµå†…éƒ¨ä¼šè¢«è¿‡æ»¤ï¼‰

**åŠ¨æ€Promptç¤ºä¾‹**ï¼š
```javascript
// é™æ€prompt
prompt: `[ä¿å­˜çŸ¥è¯†:çŸ¥è¯†åº“å:å†…å®¹] - ä¿å­˜çŸ¥è¯†`

// åŠ¨æ€promptï¼ˆæ¨èï¼‰
prompt: () => {
  const databases = this.getDatabasesSync();
  return `[ä¿å­˜çŸ¥è¯†:çŸ¥è¯†åº“å:å†…å®¹] - ä¿å­˜çŸ¥è¯†\nå¯ç”¨çŸ¥è¯†åº“ï¼š${databases.join('ã€')}`;
}
```

### ä¸Šä¸‹æ–‡ä¼ é€’æœºåˆ¶

å·¥ä½œæµä¼šè‡ªåŠ¨åœ¨æ­¥éª¤é—´ä¼ é€’ä¸Šä¸‹æ–‡ï¼š

```mermaid
sequenceDiagram
    participant Step1 as æ­¥éª¤1
    participant Context as workflow.context
    participant Step2 as æ­¥éª¤2
    participant Step3 as æ­¥éª¤3
    
    Step1->>Step1: æ‰§è¡Œä»»åŠ¡
    Step1->>Context: è®¾ç½®context.fileContent
    Step1->>Context: mergeContextåˆå¹¶ä¸Šä¸‹æ–‡
    Step2->>Context: è¯»å–fileContent
    Step2->>Step2: ä½¿ç”¨fileContentå®Œæˆä»»åŠ¡
    Step2->>Context: è®¾ç½®æ–°çš„context.xxx
    Step3->>Context: è¯»å–ä¹‹å‰æ­¥éª¤çš„ä¸Šä¸‹æ–‡
    Step3->>Step3: ç»§ç»­æ‰§è¡Œä»»åŠ¡
```

**ä»£ç ç¤ºä¾‹**ï¼š
```javascript
// æ­¥éª¤1ï¼šè®¾ç½®æ•°æ®
handler: async (params, context) => {
  context.fileContent = 'æ–‡ä»¶å†…å®¹';
  context.myResult = { success: true };
}

// æ­¥éª¤2ï¼šè‡ªåŠ¨è·å–æ•°æ®
handler: async (params, context) => {
  const data = context.fileContent; // è‡ªåŠ¨å¯ç”¨
  const result = context.myResult; // è‡ªåŠ¨å¯ç”¨
}
```

---

## è®°å¿†ç³»ç»Ÿ

### è®°å¿†ç³»ç»Ÿæ¶æ„

```mermaid
flowchart TB
    subgraph Memory["è®°å¿†ç³»ç»Ÿï¼ˆRediså­˜å‚¨ï¼‰"]
        subgraph MessageMemory["æ¶ˆæ¯è®°å¿†"]
            M1["ai:memory:chat:group_123<br/>chatå·¥ä½œæµ<br/>æ”¯æŒEmbeddingæ£€ç´¢"]
            M2["ai:memory:desktop:group_123<br/>desktopå·¥ä½œæµ<br/>æ”¯æŒEmbeddingæ£€ç´¢"]
            M3["ai:memory:chat-desktop:group_123<br/>åˆå¹¶å·¥ä½œæµ<br/>æ”¯æŒEmbeddingæ£€ç´¢"]
        end
        
        subgraph NoteMemory["ç¬”è®°è®°å¿†"]
            N1["ai:notes:workflow_xxx<br/>TODOç¬”è®°<br/>30åˆ†é’Ÿè¿‡æœŸ<br/>ä¸´æ—¶è®°å¿†"]
        end
        
        subgraph WorkflowMemory["å·¥ä½œæµè®°å¿†"]
            W1["ai:workflow:workflow_xxx<br/>å·¥ä½œæµå…ƒæ•°æ®<br/>3å¤©è¿‡æœŸ<br/>æŒä¹…åŒ–è®°å¿†"]
        end
    end
    
    subgraph Embedding["Embeddingæ£€ç´¢"]
        E1["æœ¬åœ°æ¨¡å¼<br/>BM25ç®—æ³•<br/>é›¶ä¾èµ–"]
        E2["è¿œç¨‹æ¨¡å¼<br/>APIæ¥å£<br/>å‘é‡ç›¸ä¼¼åº¦"]
    end
    
    MessageMemory --> Embedding
    Embedding --> M1
    Embedding --> M2
    Embedding --> M3
    
    style MessageMemory fill:#E6F3FF
    style NoteMemory fill:#FFE6CC
    style WorkflowMemory fill:#90EE90
    style Embedding fill:#87CEEB
```

### æ ¸å¿ƒè®¾è®¡åŸåˆ™

1. **å·¥ä½œæµç‹¬ç«‹è®°å¿†**ï¼šæ¯ä¸ªå·¥ä½œæµæœ‰ç‹¬ç«‹çš„è®°å¿†ç³»ç»Ÿï¼Œä¸ä¼šäº’ç›¸å¹²æ‰°
2. **åˆå¹¶å·¥ä½œæµç‹¬ç«‹è®°å¿†**ï¼šåˆå¹¶åçš„å·¥ä½œæµä½¿ç”¨åˆå¹¶åçš„åç§°ä½œä¸ºé”®
3. **TODOä¸´æ—¶è®°å¿†**ï¼šTODOç¬”è®°30åˆ†é’Ÿè‡ªåŠ¨è¿‡æœŸï¼Œåªåœ¨TODOå¾ªç¯å†…æœ‰æ•ˆ
4. **é”®å€¼å¯¹ä¸å†²çª**ï¼šä½¿ç”¨å·¥ä½œæµåç§°ç¡®ä¿å”¯ä¸€æ€§
5. **Embeddingæ¨¡å¼**ï¼šæ”¯æŒæœ¬åœ°ï¼ˆBM25ï¼‰å’Œè¿œç¨‹ï¼ˆAPIï¼‰ä¸¤ç§æ¨¡å¼ï¼Œè‡ªåŠ¨ä»é…ç½®è¯»å–
6. **è‡ªåŠ¨ä¸Šä¸‹æ–‡å¢å¼º**ï¼š`buildEnhancedContext` è‡ªåŠ¨æ£€ç´¢å†å²å¯¹è¯å’ŒçŸ¥è¯†åº“ï¼Œæ— éœ€æ‰‹åŠ¨è°ƒç”¨

### è®°å¿†ç±»å‹

#### 1. æ¶ˆæ¯è®°å¿†

**å­˜å‚¨é”®**: `ai:memory:{streamName}:{groupId}`

**ç‰¹ç‚¹**ï¼š
- æ¯ä¸ªå·¥ä½œæµç‹¬ç«‹
- åˆå¹¶å·¥ä½œæµä½¿ç”¨åˆå¹¶åçš„åç§°
- æ”¯æŒembeddingæ£€ç´¢

**ç¤ºä¾‹**ï¼š
- `chat`å·¥ä½œæµï¼š`ai:memory:chat:group_123`
- `desktop`å·¥ä½œæµï¼š`ai:memory:desktop:group_123`
- `chat-desktop`åˆå¹¶å·¥ä½œæµï¼š`ai:memory:chat-desktop:group_123`

#### 2. ç¬”è®°è®°å¿†ï¼ˆTODOä¸´æ—¶è®°å¿†ï¼‰

**å­˜å‚¨é”®**: `ai:notes:{workflowId}`

**ç‰¹ç‚¹**ï¼š
- 30åˆ†é’Ÿè‡ªåŠ¨è¿‡æœŸ
- åªåœ¨TODOå¾ªç¯å†…æœ‰æ•ˆ
- æ‰€æœ‰TODOæ­¥éª¤å…±äº«

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```javascript
// å­˜å‚¨TODOç¬”è®°
await stream.storeNote(workflowId, 'æ¡Œé¢æ–‡ä»¶åˆ—è¡¨ï¼šå¾®ä¿¡.lnk', 'todo_0', true);

// è·å–æ‰€æœ‰ç¬”è®°ï¼ˆè‡ªåŠ¨è¿‡æ»¤è¿‡æœŸç¬”è®°ï¼‰
const notes = await stream.getNotes(workflowId);
```

#### 3. å·¥ä½œæµè®°å¿†

**å­˜å‚¨é”®**: `ai:workflow:{workflowId}`

**ç‰¹ç‚¹**ï¼š
- å­˜å‚¨å·¥ä½œæµå…ƒæ•°æ®
- 3å¤©è¿‡æœŸ

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```javascript
await stream.storeWorkflowMemory(workflowId, {
  goal: 'æ‰“å¼€å¾®ä¿¡å¹¶å‘é€æ¶ˆæ¯',
  todos: ['æŸ¥çœ‹æ¡Œé¢', 'æ‰“å¼€å¾®ä¿¡', 'å‘é€æ¶ˆæ¯'],
  createdAt: Date.now()
});
```

---

## å·¥ä½œæµåˆå¹¶æœºåˆ¶

### åˆå¹¶åŸç†

å·¥ä½œæµåˆå¹¶æ˜¯æŒ‡å°†**å¤šä¸ªå·¥ä½œæµçš„åŠŸèƒ½**åˆå¹¶åˆ°ä¸€ä¸ªå·¥ä½œæµä¸­ï¼Œä½†**åªåˆå¹¶functionsï¼Œä¸åˆå¹¶äººè®¾/ä¸Šä¸‹æ–‡**ã€‚

```mermaid
flowchart TB
    subgraph Main["ä¸»å·¥ä½œæµ chat"]
        MainPersona["äººè®¾: æˆ‘æ˜¯AIåŠ©æ‰‹"]
        MainContext["ä¸Šä¸‹æ–‡: èŠå¤©å†å²"]
        MainFuncs["å‡½æ•°: send_message<br/>get_history"]
    end

    subgraph Secondary["å‰¯å·¥ä½œæµ desktop"]
        SecPersona["äººè®¾: æ¡Œé¢æ“ä½œåŠ©æ‰‹"]
        SecContext["ä¸Šä¸‹æ–‡: æ¡Œé¢æ–‡ä»¶"]
        SecFuncs["å‡½æ•°: open_application<br/>list_desktop_files"]
    end

    subgraph Merged["åˆå¹¶å chat-desktop"]
        MergedPersona["äººè®¾: æˆ‘æ˜¯AIåŠ©æ‰‹<br/>ä¿ç•™ä¸»å·¥ä½œæµ"]
        MergedContext["ä¸Šä¸‹æ–‡: èŠå¤©å†å²<br/>ä¿ç•™ä¸»å·¥ä½œæµ"]
        MergedFuncs["å‡½æ•°: send_message<br/>get_history<br/>desktop.open_application<br/>desktop.list_desktop_files<br/>å‰¯å·¥ä½œæµåŠ å‰ç¼€"]
    end

    MainFuncs --> MergedFuncs
    SecFuncs --> MergedFuncs
    MainPersona --> MergedPersona
    MainContext --> MergedContext
    
    style Main fill:#E6F3FF
    style Secondary fill:#FFE6CC
    style Merged fill:#90EE90
```

### åˆå¹¶è§„åˆ™

1. **äººè®¾å’Œä¸Šä¸‹æ–‡**ï¼šåªä¿ç•™ä¸»å·¥ä½œæµçš„
2. **å‡½æ•°**ï¼šåˆå¹¶æ‰€æœ‰å·¥ä½œæµçš„å‡½æ•°
3. **å‡½æ•°å‰ç¼€**ï¼šå‰¯å·¥ä½œæµçš„å‡½æ•°è‡ªåŠ¨åŠ å‰ç¼€ï¼ˆå¦‚`desktop.open_application`ï¼‰
4. **å‡½æ•°å†²çª**ï¼šå¦‚æœå‡½æ•°åå†²çªï¼Œä¼˜å…ˆä½¿ç”¨ä¸»å·¥ä½œæµçš„

### ä½¿ç”¨åœºæ™¯

**åœºæ™¯1**ï¼šèŠå¤©å·¥ä½œæµéœ€è¦æ¡Œé¢æ“ä½œåŠŸèƒ½
```javascript
const stream = StreamLoader.mergeStreams({
  name: 'chat-desktop',
  main: 'chat',
  secondary: ['desktop']
});
```

**åœºæ™¯2**ï¼šè®¾å¤‡å·¥ä½œæµéœ€è¦AIå¯¹è¯èƒ½åŠ›
```javascript
const stream = StreamLoader.mergeStreams({
  name: 'device-chat',
  main: 'device',
  secondary: ['chat']
});
```

---

## MCPå·¥å…·æ³¨å†Œ

> **è¯¦ç»†æ–‡æ¡£**ï¼šè¯·å‚è€ƒ **[`docs/mcp-guide.md`](mcp-guide.md)** - MCPå®Œæ•´æŒ‡å—

### å¿«é€Ÿæ¦‚è§ˆ

MCP (Model Context Protocol) æ˜¯XRK-AGTæä¾›çš„æ ‡å‡†åŒ–å·¥å…·è°ƒç”¨åè®®ï¼Œå…è®¸å¤–éƒ¨AIå¹³å°ï¼ˆå¦‚å°æ™ºAIã€Claudeã€è±†åŒ…ï¼‰é€šè¿‡HTTP/WebSocketè¿æ¥å¹¶è°ƒç”¨ç³»ç»Ÿå·¥å…·ã€‚

**æ ¸å¿ƒç‰¹æ€§**ï¼š
- âœ… æ‰€æœ‰å·¥ä½œæµçš„å‡½æ•°è‡ªåŠ¨æ³¨å†Œä¸ºMCPå·¥å…·
- âœ… æä¾›HTTP REST APIå’ŒWebSocketæ¥å£
- âœ… æ”¯æŒå¤šå¹³å°è¿æ¥ï¼ˆå°æ™ºAIã€Claudeã€è±†åŒ…ï¼‰

**APIç«¯ç‚¹**ï¼š
- `GET /api/mcp/tools` - è·å–å·¥å…·åˆ—è¡¨
- `POST /api/mcp/tools/call` - è°ƒç”¨å·¥å…·
- `GET /api/mcp/connect` - SSEè¿æ¥
- `WS /mcp/ws` - WebSocketè¿æ¥

---

## æœ€ä½³å®è·µ

### 1. å·¥ä½œæµè®¾è®¡åŸåˆ™

- **å•ä¸€èŒè´£**ï¼šæ¯ä¸ªå·¥ä½œæµä¸“æ³¨äºä¸€ä¸ªé¢†åŸŸ
- **åŠŸèƒ½æ¨¡å—åŒ–**ï¼šé€šè¿‡å‡½æ•°æ³¨å†Œæä¾›åŠŸèƒ½
- **å¯ç»„åˆæ€§**ï¼šæ”¯æŒå·¥ä½œæµåˆå¹¶

### 2. å‡½æ•°è®¾è®¡åŸåˆ™

- **æ¸…æ™°çš„æè¿°**ï¼š`description`å’Œ`prompt`è¦æ¸…æ™°
- **å‚æ•°éªŒè¯**ï¼šåœ¨handlerä¸­éªŒè¯å‚æ•°
- **é”™è¯¯å¤„ç†**ï¼šå¦¥å–„å¤„ç†é”™è¯¯ï¼Œè¿”å›å‹å¥½æç¤º
- **ä½¿ç”¨åŠ¨æ€prompt**ï¼šåŒ…å«å®æ—¶ä¿¡æ¯ï¼ˆå¦‚çŸ¥è¯†åº“åˆ—è¡¨ã€è®°å¿†åˆ—è¡¨ï¼‰

### 3. TODOå·¥ä½œæµè®¾è®¡

- **ä»»åŠ¡ç²’åº¦**ï¼šæ¯ä¸ªTODOåº”è¯¥æ˜¯å¯æ‰§è¡Œçš„ã€æ¸…æ™°çš„æ“ä½œ
- **ç¬”è®°è®°å½•**ï¼šé‡è¦ä¿¡æ¯è¦è®°å½•åˆ°ç¬”è®°
- **å®Œæˆåº¦è¯„ä¼°**ï¼šå®¢è§‚è¯„ä¼°å®Œæˆåº¦

### 4. ä»£ç ä¼˜åŒ–åŸåˆ™

- **åˆ é™¤å†—ä½™åˆ¤æ–­**ï¼šé¿å…ä¸å¿…è¦çš„å­˜åœ¨æ€§æ£€æŸ¥
- **åˆå¹¶å†—ä½™å‡½æ•°**ï¼šåˆ é™¤åªåšç®€å•åŒ…è£…çš„å‡½æ•°
- **ç®€åŒ–åµŒå¥—**ï¼šå‡å°‘try-catchåµŒå¥—ï¼Œä½¿ç”¨`.catch()`é“¾å¼è°ƒç”¨
- **ç»Ÿä¸€replyæœºåˆ¶**ï¼šæ‰€æœ‰å·¥ä½œæµæ¶ˆæ¯ç”±`sendReply()`ç»Ÿä¸€å‘é€ï¼Œæ’ä»¶ä¸å¤„ç†

### 5. å·¥ä½œæµReplyæœºåˆ¶

**æ ¸å¿ƒåŸåˆ™**ï¼š
- âœ… **å·¥ä½œæµè´Ÿè´£æ‰€æœ‰reply**ï¼šä¸€æ—¦å·¥ä½œæµå¯åŠ¨ï¼Œæ‰€æœ‰æ¶ˆæ¯ç”±å·¥ä½œæµç®¡ç†å™¨ç»Ÿä¸€å‘é€
- âœ… **æ’ä»¶ä¸è´Ÿè´£reply**ï¼šæ’ä»¶åªéœ€ä¼ é€’`e`ç»™å·¥ä½œæµï¼Œä¸éœ€è¦è°ƒç”¨`reply()`
- âœ… **æ ‡å‡†åŒ–è¾“å‡ºæ ¼å¼**ï¼šæ‰€æœ‰å·¥ä½œæµå›å¤ä½¿ç”¨ç»Ÿä¸€çš„JSONæ ¼å¼ï¼Œä¾¿äºå®¢æˆ·ç«¯ï¼ˆå¦‚taskerï¼‰è§£æ

**Replyæ ¼å¼**ï¼š
```json
{
  "type": "workflow",
  "event": "start|step|complete|error|retry|update",
  "workflowId": "workflow_1234567890_abc123",
  "goal": "å¸®æˆ‘åˆ†ææ˜“å¿˜ä¿¡æ¯.txtå¹¶åˆ›å»ºexcelè¡¨æ ¼",
  "progress": { "completed": 2, "total": 4 },
  "iteration": 1,
  "timestamp": 1234567890,
  "task": "è¯»å–æ–‡ä»¶å†…å®¹",
  "action": "[è¯»å–æ–‡ä»¶:æ˜“å¿˜ä¿¡æ¯.txt]",
  "completion": 0.9
}
```

---

## å¸¸è§é—®é¢˜

### Q: å·¥ä½œæµä¸å¯åŠ¨æ€ä¹ˆåŠï¼Ÿ

**A**: æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š
1. `workflowManager`æ˜¯å¦æ­£ç¡®æ³¨å…¥
2. `decideWorkflowMode`çš„è¿”å›å€¼
3. æŸ¥çœ‹æ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯

### Q: ä¸Šä¸‹æ–‡ä¸ä¼ é€’æ€ä¹ˆåŠï¼Ÿ

**A**: ç¡®ä¿ï¼š
1. åœ¨handlerä¸­è®¾ç½®`context.xxx`
2. `workflowId`æ˜¯å¦å­˜åœ¨
3. æ•°æ®æ ¼å¼æ­£ç¡®

### Q: å‡½æ•°ä¸æ‰§è¡Œæ€ä¹ˆåŠï¼Ÿ

**A**: æ£€æŸ¥ï¼š
1. å‡½æ•°æ˜¯å¦å·²æ³¨å†Œ
2. parseræ˜¯å¦æ­£ç¡®è§£æ
3. `enabled`æ˜¯å¦ä¸ºtrue

### Q: å¦‚ä½•è°ƒè¯•å·¥ä½œæµï¼Ÿ

**A**: 
1. æŸ¥çœ‹å·¥ä½œæµç¬”è®°ï¼š`workflow.notes`
2. æŸ¥çœ‹æ‰§è¡Œå†å²ï¼š`workflow.history`
3. æ£€æŸ¥ä¸Šä¸‹æ–‡ï¼š`workflow.context`
4. æŸ¥çœ‹è°ƒè¯•æ—¥å¿—ï¼š`data/debug/workflow-{workflowId}.json`

---

## ç›¸å…³æ–‡æ¡£

- **[å·¥ä½œæµè®°å¿†ç³»ç»Ÿ](workflow-memory-system.md)** - è®°å¿†ç³»ç»Ÿè¯¦ç»†æ–‡æ¡£
- **[å¤æ‚ä»»åŠ¡ç¤ºä¾‹](workflow-complex-task-example.md)** - å¤æ‚ä»»åŠ¡å®Œæ•´è°ƒç”¨æµç¨‹æ¨¡æ‹Ÿ
- **[MCPå®Œæ•´æŒ‡å—](mcp-guide.md)** - MCPå·¥å…·æ³¨å†Œä¸è¿æ¥
- **[å·¥ä½œæµå¼€å‘æ–‡æ¡£](å·¥ä½œæµå¼€å‘æ–‡æ¡£.md)** - å¼€å‘å·¥ä½œæµçš„è¯¦ç»†æŒ‡å—

---

## æ€»ç»“

XRK-AGTçš„å·¥ä½œæµç³»ç»Ÿæ˜¯ä¸€ä¸ª**åŠŸèƒ½å¼ºå¤§ã€å¯æ“ä½œã€å¯æ‰©å±•**çš„ç³»ç»Ÿï¼š

- âœ… **æ™ºèƒ½å†³ç­–**ï¼šè‡ªåŠ¨åˆ¤æ–­ä»»åŠ¡å¤æ‚åº¦
- âœ… **å·¥ä½œæµåˆå¹¶**ï¼šçµæ´»ç»„åˆå¤šä¸ªå·¥ä½œæµ
- âœ… **ä¸Šä¸‹æ–‡ä¼ é€’**ï¼šè‡ªåŠ¨åœ¨æ­¥éª¤é—´ä¼ é€’æ‰§è¡Œç»“æœ
- âœ… **ç»Ÿä¸€è®°å¿†**ï¼šæ¶ˆæ¯ã€ç¬”è®°ã€å·¥ä½œæµè®°å¿†ç»Ÿä¸€ç®¡ç†
- âœ… **å‡½æ•°è°ƒç”¨**ï¼šAIå¯ä»¥è°ƒç”¨æ³¨å†Œçš„å‡½æ•°æ‰§è¡Œæ“ä½œ

æ•´ä¸ªç³»ç»Ÿè®¾è®¡éµå¾ª"**åº•å±‚å¹²å‡€ç®€æ´ï¼Œä¸Šå±‚åŠŸèƒ½å¼ºå¤§**"çš„åŸåˆ™ï¼Œæ—¢ä¿è¯äº†åº•å±‚çš„ä¸€è‡´æ€§ï¼Œåˆæä¾›äº†ä¸Šå±‚çš„çµæ´»æ€§ã€‚


