# XRK-AGT å®Œæ•´æ–‡æ¡£

> æœ¬æ–‡æ¡£æ•´åˆäº†æ¡†æ¶çš„æ‰€æœ‰æ ¸å¿ƒæ–‡æ¡£ï¼Œæä¾›å®Œæ•´çš„å¼€å‘æŒ‡å—å’ŒAPIå‚è€ƒã€‚
> **æ¡†æ¶å¯æ‰©å±•æ€§**ï¼šXRK-AGTé‡‡ç”¨åˆ†å±‚æ¶æ„+åŸºç±»è®¾è®¡+åŠ è½½å™¨æœºåˆ¶ï¼Œå®ç°äº†æé«˜çš„å¯æ‰©å±•æ€§ã€‚è¯¦è§ **[æ¡†æ¶å¯æ‰©å±•æ€§æŒ‡å—](æ¡†æ¶å¯æ‰©å±•æ€§æŒ‡å—.md)** â­ æ¨è

## ğŸ“‘ ç›®å½•å¯¼èˆª

- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [æ¶æ„æ€»è§ˆ](#æ¶æ„æ€»è§ˆ)
- [æ¶æ„å±‚æ¬¡è¯´æ˜](#æ¶æ„å±‚æ¬¡è¯´æ˜)
- [æ ¸å¿ƒæ¨¡å—](#æ ¸å¿ƒæ¨¡å—)
- [æ¡†æ¶å¯æ‰©å±•æ€§](#æ¡†æ¶å¯æ‰©å±•æ€§) â­ æ–°å¢
- [ServeræœåŠ¡å™¨æ¶æ„](server.md) â­ æ–°å¢
- [HTTPä¸šåŠ¡å±‚](http-business-layer.md) â­ æ–°å¢
  - [Botä¸»ç±»](#botä¸»ç±»)
  - [åŸºç¡€è®¾æ–½å±‚](#åŸºç¡€è®¾æ–½å±‚è¾…åŠ©å±‚)
  - [ä»»åŠ¡å±‚ï¼ˆTaskerï¼‰](#ä»»åŠ¡å±‚tasker)
  - [äº‹ä»¶ç³»ç»Ÿ](#äº‹ä»¶ç³»ç»Ÿ)
  - [æ’ä»¶ç³»ç»Ÿ](#æ’ä»¶ç³»ç»Ÿ)
  - [HTTP/APIå±‚](#httpapiå±‚)
  - [AIå·¥ä½œæµ](#aiå·¥ä½œæµ)
  - [é…ç½®ç³»ç»Ÿ](#é…ç½®ç³»ç»Ÿ)
  - [æ¸²æŸ“ç³»ç»Ÿ](#æ¸²æŸ“ç³»ç»Ÿ)
  - [å·¥å…·ç±»](#å·¥å…·ç±»)
- [å¼€å‘æŒ‡å—](#å¼€å‘æŒ‡å—)
- [APIå‚è€ƒ](#apiå‚è€ƒ)

---

## å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- **Node.js**: â‰¥ 24.12.0ï¼ˆLTS ç‰ˆæœ¬ï¼Œæ¨èï¼‰
- **pnpm**: æœ€æ–°ç‰ˆæœ¬
- **Redis**: â‰¥ 5.0.0
- **MongoDB**: â‰¥ 4.0.0ï¼ˆå¯é€‰ï¼‰

### å®‰è£…ä¸è¿è¡Œ

```bash
# å…‹éš†é¡¹ç›®ï¼ˆGitHubï¼‰
git clone --depth=1 https://github.com/sunflowermm/XRK-AGT.git
# æˆ–ä½¿ç”¨ GitCodeï¼ˆå›½å†…é•œåƒï¼‰
git clone --depth=1 https://gitcode.com/Xrkseek/XRK-AGT.git
cd XRK-AGT

# å®‰è£…ä¾èµ–ï¼ˆä»…æ”¯æŒ pnpmï¼‰
pnpm install

# è¿è¡Œ
node app
```

### é¡¹ç›®ç»“æ„

```mermaid
graph TD
    Root["XRK-AGT/"] --> App["app.js / start.js<br/>å¯åŠ¨å…¥å£"]
    Root --> Src["src/<br/>è¿è¡Œæ ¸å¿ƒä¸åŸºç¡€è®¾æ–½"]
    Root --> Core["core/<br/>ä¸šåŠ¡å±‚ä¸ä»»åŠ¡å±‚"]
    Root --> Config["config/<br/>é…ç½®æ–‡ä»¶"]
    Root --> Docs["docs/<br/>æ–‡æ¡£"]
    Root --> Www["www/<br/>Webå‰ç«¯"]
    
    Src --> Bot["bot.js<br/>Botä¸»ç±»"]
    Src --> Infra["infrastructure/<br/>åŸºç¡€è®¾æ–½å±‚"]
    Src --> Utils["utils/<br/>å·¥å…·å‡½æ•°"]
    
    Infra --> TaskerLoader["tasker/loader.js<br/>TaskerLoader"]
    Infra --> PluginsInfra["plugins/<br/>æ’ä»¶ç³»ç»ŸåŸºç¡€è®¾æ–½"]
    Infra --> ListenerInfra["listener/<br/>äº‹ä»¶ç›‘å¬å™¨åŸºç¡€è®¾æ–½"]
    Infra --> HttpInfra["http/<br/>HTTP APIåŸºç¡€è®¾æ–½"]
    Infra --> AistreamInfra["aistream/<br/>AIå·¥ä½œæµåŸºç¡€è®¾æ–½"]
    Infra --> RendererInfra["renderer/<br/>æ¸²æŸ“å™¨åŸºç¡€è®¾æ–½"]
    
    Core --> TaskerCore["tasker/<br/>ä»»åŠ¡å±‚"]
    Core --> Events["events/<br/>äº‹ä»¶ç³»ç»Ÿ"]
    Core --> PluginCore["plugin/<br/>ä¸šåŠ¡æ’ä»¶"]
    Core --> HttpCore["http/<br/>HTTP API"]
    Core --> StreamCore["stream/<br/>AIå·¥ä½œæµ"]
    
    style Root fill:#FFD700
    style Bot fill:#87CEEB
    style Infra fill:#90EE90
    style Core fill:#FFB6C1
```

---

## æ¶æ„æ€»è§ˆ

### æ ¸å¿ƒç»„ä»¶å…³ç³»

```mermaid
flowchart LR
    subgraph Clients["å¤–éƒ¨å®¢æˆ·ç«¯"]
      QQ["QQ / OneBotv11"] -->|WS| Taskers
      WebUI["XRK Web æ§åˆ¶å°"] -->|HTTP/WS| Express
      ThirdAPI["ç¬¬ä¸‰æ–¹è°ƒç”¨æ–¹"] -->|HTTP/WS| Express
    end

    subgraph Protocol["åè®®è½¬æ¢"]
      ProtocolConv["åè®®è½¬æ¢å±‚"]
    end

    subgraph Core["XRK-AGT æ ¸å¿ƒ"]
      Express["HTTP/HTTPS/WS æœåŠ¡<br/>src/bot.js"]
      Taskers["ä»»åŠ¡å±‚<br/>core/*/tasker"]
      EventSystem["äº‹ä»¶ç³»ç»Ÿ<br/>core/*/events"]
      PluginsLoader["æ’ä»¶åŠ è½½å™¨<br/>src/infrastructure/plugins"]
      ApiLoader["API åŠ è½½å™¨<br/>src/infrastructure/http"]
      Plugins["ä¸šåŠ¡æ’ä»¶<br/>core/*/plugin"]
      HttpApis["HTTP API<br/>core/*/http"]
      AIStream["AI å·¥ä½œæµåŸºç±»<br/>src/infrastructure/aistream"]
      Renderer["æ¸²æŸ“å™¨åŸºç±»<br/>src/infrastructure/renderer"]
    end

    QQ -->|WS| ProtocolConv
    WeChat -->|WS/HTTP| ProtocolConv
    WebUI -->|HTTP/WS| Express
    ThirdAPI -->|HTTP/WS| Express
    
    ProtocolConv --> Taskers
    Taskers -->|Bot.em äº‹ä»¶| EventSystem
    EventSystem -->|å»é‡/æ ‡è®°| PluginsLoader
    Express --> ApiLoader
    ApiLoader --> HttpApis
    PluginsLoader --> Plugins
    Plugins --> AIStream
    Plugins --> Renderer
    HttpApis --> AIStream
    HttpApis --> Renderer
    
    style Clients fill:#E6F3FF
    style Core fill:#FFE6CC
```

### è¿è¡Œæµç¨‹

```mermaid
flowchart TB
    subgraph Start["å¯åŠ¨é˜¶æ®µ"]
        A["app.js<br/>ç¯å¢ƒæ£€æŸ¥"] --> B["å®‰è£…ä¾èµ–"]
        B --> C["start.js<br/>åˆ›å»ºBotå®ä¾‹"]
        C --> D["åŠ è½½é…ç½®"]
        D --> E["åŠ è½½Tasker"]
        E --> F["åŠ è½½äº‹ä»¶ç›‘å¬å™¨"]
        F --> G["åŠ è½½æ’ä»¶"]
        G --> H["åŠ è½½API"]
        H --> I["å¯åŠ¨HTTP/WSæœåŠ¡"]
    end
    
    subgraph Runtime["è¿è¡Œé˜¶æ®µ"]
        J["Taskeræ¥æ”¶æ¶ˆæ¯"] --> K["Bot.emè§¦å‘äº‹ä»¶"]
        K --> L["äº‹ä»¶ç›‘å¬å™¨å¤„ç†"]
        L --> M["å»é‡/æ ‡å‡†åŒ–"]
        M --> N["æ’ä»¶ç³»ç»ŸåŒ¹é…è§„åˆ™"]
        N --> O["æ‰§è¡Œæ’ä»¶"]
        O --> P["è°ƒç”¨AIå·¥ä½œæµ/æ¸²æŸ“å™¨"]
    end
    
    subgraph HTTP["HTTPæœåŠ¡"]
        Q["Expressæ¥æ”¶è¯·æ±‚"] --> R["APIè·¯ç”±å¤„ç†"]
        R --> S["ä¸šåŠ¡é€»è¾‘æ‰§è¡Œ"]
        S --> T["è¿”å›å“åº”/WebSocketæ¶ˆæ¯"]
    end
    
    I --> J
    I --> Q
    
    style A fill:#E6F3FF
    style K fill:#FFE6CC
    style Q fill:#E6FFE6
```

---

## æ¶æ„å±‚æ¬¡è¯´æ˜

XRK-AGT é‡‡ç”¨æ¸…æ™°çš„åˆ†å±‚æ¶æ„ï¼Œå„å±‚èŒè´£æ˜ç¡®ï¼š

### ğŸ—ï¸ æ¶æ„å±‚æ¬¡å›¾

```mermaid
flowchart TB
    subgraph Runtime["è¿è¡Œæ ¸å¿ƒå±‚"]
      Bot["Bot ä¸»ç±»<br/>src/bot.js<br/>ç»Ÿä¸€ç®¡ç†æ‰€æœ‰ç»„ä»¶"]
    end

    subgraph Infrastructure["åŸºç¡€è®¾æ–½å±‚ï¼ˆè¾…åŠ©å±‚ï¼‰"]
      Loaders["åŠ è½½å™¨<br/>TaskerLoader/PluginsLoader<br/>ApiLoader/StreamLoader<br/>ListenerLoader"]
      BaseClasses["åŸºç±»åº“<br/>plugin/HttpApi/AIStream<br/>Renderer/ConfigBase/EventListener"]
      DB["æ•°æ®åº“å®¢æˆ·ç«¯<br/>redis/mongodb"]
    end

    subgraph Tasker["ä»»åŠ¡å±‚ï¼ˆTaskerï¼‰"]
      Taskers["å„å¹³å° Tasker<br/>OneBotv11<br/>stdin/è‡ªå®šä¹‰"]
    end

    subgraph EventSystem["äº‹ä»¶ç³»ç»Ÿ"]
      Listeners["äº‹ä»¶ç›‘å¬å™¨<br/>onebot/device/stdin"]
    end

    subgraph Business["ä¸šåŠ¡å±‚"]
      Plugins["ä¸šåŠ¡æ’ä»¶<br/>core/*/plugin/"]
      HttpApis["HTTP API<br/>core/*/http/"]
      Streams["å·¥ä½œæµ<br/>core/*/stream/"]
    end

    Bot --> Loaders
    Bot --> BaseClasses
    Loaders --> Taskers
    Loaders --> Listeners
    Loaders --> Plugins
    Loaders --> HttpApis
    Loaders --> Streams
    Taskers -->|Bot.em è§¦å‘| Listeners
    Listeners -->|å»é‡/æ ‡è®°| Plugins
    
    style Runtime fill:#E6F3FF
    style Infrastructure fill:#FFE6CC
    style Tasker fill:#90EE90
    style EventSystem fill:#87CEEB
    style Business fill:#FFB6C1
```

### ğŸ“‹ å„å±‚èŒè´£

#### 1. è¿è¡Œæ ¸å¿ƒå±‚ (`src/bot.js`)
- **èŒè´£**ï¼šç»Ÿä¸€ç®¡ç† HTTP/HTTPS/WebSocket æœåŠ¡ã€ä¸­é—´ä»¶ã€è®¤è¯ã€åå‘ä»£ç†ã€äº‹ä»¶æ€»çº¿ (`Bot.em`)
- **ç‰¹ç‚¹**ï¼šç³»ç»Ÿå…¥å£ï¼Œåè°ƒæ‰€æœ‰ç»„ä»¶

#### 2. åŸºç¡€è®¾æ–½å±‚ï¼ˆè¾…åŠ©å±‚ï¼‰(`src/infrastructure/`)
- **èŒè´£**ï¼šæä¾›æ‰€æœ‰åŸºç¡€è®¾æ–½å’ŒåŸºç±»ï¼Œä¸ºä¸šåŠ¡å±‚æä¾›é€šç”¨èƒ½åŠ›
- **åŒ…å«**ï¼š
  - **åŠ è½½å™¨**ï¼š`TaskerLoader`ã€`PluginsLoader`ã€`ApiLoader`ã€`StreamLoader`ã€`ListenerLoader`
  - **åŸºç±»åº“**ï¼š`plugin`ã€`HttpApi`ã€`AIStream`ã€`Renderer`ã€`ConfigBase`ã€`EventListener`
  - **æ•°æ®åº“å®¢æˆ·ç«¯**ï¼š`redis.js`ã€`mongodb.js`
- **ç‰¹ç‚¹**ï¼šä¸åŒ…å«å…·ä½“ä¸šåŠ¡é€»è¾‘ï¼Œåªæä¾›æŠ½è±¡å’Œå·¥å…·

#### 3. æ ¸å¿ƒæ¨¡å—å±‚ï¼ˆCoreï¼‰(`core/*/`)
- **èŒè´£**ï¼šæ¯ä¸ª core æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ä¸šåŠ¡æ¨¡å—ï¼Œé€šè¿‡ä¸šåŠ¡ç›®å½•ï¼ˆå¦‚ `plugin/`ã€`tasker/` ç­‰ï¼‰ç»„ç»‡ä»£ç 
- **ç‰¹ç‚¹**ï¼šæ”¯æŒå¤š core æ¨¡å—æ¶æ„ï¼Œæ¡†æ¶è‡ªåŠ¨æ‰«æå¹¶åŠ è½½æ‰€æœ‰ core ç›®å½•
- **Coreå¼€å‘æ—¶ä»£**ï¼šç°åœ¨æ‰€æœ‰ä¸šåŠ¡éƒ½åœ¨ `core/` ç›®å½•ä¸‹å¼€å‘ï¼Œcore æ ¹ç›®å½•ä¸å†ç›´æ¥å†™ä¸šåŠ¡ä»£ç ï¼Œè€Œæ˜¯é€šè¿‡ä¸šåŠ¡ç›®å½•æ¥ç»„ç»‡ä»£ç ï¼Œæ–¹ä¾¿ä¸šåŠ¡åˆ†å‰²å’Œé›†æˆ

**æ ¸å¿ƒæ¨¡å—åŒ…å«**ï¼š
- **ä»»åŠ¡å±‚ï¼ˆTaskerï¼‰** (`core/*/tasker/`)ï¼šå¯¹æ¥å„å¹³å°åè®®ï¼ˆQQ/è‡ªå®šä¹‰ï¼‰ï¼Œå°†å¹³å°æ¶ˆæ¯è½¬æ¢ä¸ºç»Ÿä¸€äº‹ä»¶æ¨¡å‹ï¼Œé€šè¿‡ `Bot.em` è§¦å‘äº‹ä»¶
- **äº‹ä»¶ç³»ç»Ÿ** (`core/*/events/`)ï¼šç›‘å¬ `Bot.em` äº‹ä»¶ï¼Œè¿›è¡Œå»é‡ã€æ ‡è®°ã€é¢„å¤„ç†ï¼Œç„¶åè°ƒç”¨ `PluginsLoader.deal(e)` åˆ†å‘åˆ°æ’ä»¶
- **ä¸šåŠ¡å±‚**ï¼š
  - **ä¸šåŠ¡æ’ä»¶** (`core/*/plugin/`)ï¼šåŒ…æ‹¬ `enhancer/`ï¼ˆå¢å¼ºæ’ä»¶ï¼‰å’Œ `example/`ï¼ˆç¤ºä¾‹æ’ä»¶ï¼‰
  - **HTTP API** (`core/*/http/`)ï¼šå…·ä½“çš„ REST/WebSocket API å®ç°
  - **å·¥ä½œæµ** (`core/*/stream/`)ï¼šåŸºäº `AIStream` çš„ä¸šåŠ¡å·¥ä½œæµå®ç°
  - **é…ç½®ç®¡ç†** (`core/*/commonconfig/`)ï¼šå­˜æ”¾ç»§æ‰¿ `ConfigBase` åŸºç±»çš„é…ç½®ç®¡ç†ç±»ï¼ˆâš ï¸ ä»…å½“éœ€è¦é…ç½®æ–‡ä»¶æ—¶ä½¿ç”¨ï¼‰
  - **é™æ€èµ„æº** (`core/*/www/`)ï¼šé™æ€æ–‡ä»¶
    - âš ï¸ **å¿…é¡»åˆ›å»ºå­ç›®å½•**ï¼šä¸è¦åœ¨ `www/` ä¸‹ç›´æ¥æ”¾ç½®æ–‡ä»¶ï¼Œå¿…é¡»åˆ›å»ºå­ç›®å½•ï¼ˆå¦‚ `www/xrk/`ï¼‰
    - å­ç›®å½•è‡ªåŠ¨æŒ‚è½½åˆ° `/<ç›®å½•å>/*`ï¼ˆå¦‚ `www/xrk/` æŒ‚è½½åˆ° `/xrk/*`ï¼‰ï¼Œé¿å…ä¸æ ¹ç›®å½• `www/` å†²çª

---

## æ ¸å¿ƒæ¨¡å—

### Botä¸»ç±»

**æ–‡ä»¶**: `src/bot.js`

**èŒè´£**:
- HTTP/HTTPS/WebSocketæœåŠ¡ç®¡ç†
- ä¸­é—´ä»¶é…ç½®ï¼ˆCORSã€è®¤è¯ã€é™æµç­‰ï¼‰
- åå‘ä»£ç†æ”¯æŒ
- äº‹ä»¶æ´¾å‘ï¼ˆ`Bot.em`ï¼‰
- èµ„æºæ¸…ç†

**å…³é”®æ–¹æ³•**:
- `prepareEvent(data)`: è®¾ç½®äº‹ä»¶é€šç”¨å±æ€§
- `em(name, data)`: è§¦å‘äº‹ä»¶
- `run(options)`: å¯åŠ¨æœåŠ¡

**è¯¦ç»†æ–‡æ¡£**: è§ä¸‹æ–¹[Botä¸»ç±»è¯¦ç»†è¯´æ˜](#botä¸»ç±»è¯¦ç»†è¯´æ˜)

---

### æ’ä»¶ç³»ç»Ÿ

#### æ’ä»¶åŸºç±» (`plugin`)

**æ–‡ä»¶**: `src/infrastructure/plugins/plugin.js`

**æ ¸å¿ƒæ¦‚å¿µ**:
- `name`: æ’ä»¶åç§°
- `event`: ç›‘å¬çš„äº‹ä»¶ç±»å‹
- `priority`: ä¼˜å…ˆçº§ï¼ˆè¶Šå°è¶Šå…ˆæ‰§è¡Œï¼‰
- `rule`: è§„åˆ™æ•°ç»„
- `task`: å®šæ—¶ä»»åŠ¡

**acceptæ–¹æ³•**:
```javascript
async accept(e) {
  // å‰ç½®æ£€æŸ¥ï¼Œè¿”å›true/false/'return'
  // Taskerå¢å¼ºæ’ä»¶åœ¨æ­¤æŒ‚è½½ç‰¹å®šå±æ€§
  return true
}
```

**ä¸Šä¸‹æ–‡ç®¡ç†**:
- `setContext(type, isGroup, time)`: è®¾ç½®ä¸Šä¸‹æ–‡
- `getContext(type, isGroup)`: è·å–ä¸Šä¸‹æ–‡
- `finish(type, isGroup)`: ç»“æŸä¸Šä¸‹æ–‡

#### æ’ä»¶åŠ è½½å™¨ (`PluginsLoader`)

**æ–‡ä»¶**: `src/infrastructure/plugins/loader.js`

**èŒè´£**:
- æ‰«æå¹¶åŠ è½½æ‰€æœ‰ `core/*/plugin` ç›®å½•
- è§„åˆ™åŒ¹é…ä¸æƒé™æ£€æŸ¥
- å†·å´ä¸èŠ‚æµç®¡ç†
- å®šæ—¶ä»»åŠ¡è°ƒåº¦

**äº‹ä»¶å¤„ç†æµç¨‹**:

```mermaid
sequenceDiagram
    participant Event as äº‹ä»¶å¯¹è±¡
    participant Loader as PluginsLoader
    participant Plugin as æ’ä»¶å®ä¾‹
    
    Event->>Loader: deal(e)
    Loader->>Loader: initEvent(e)
    Loader->>Loader: preCheck(e)
    Loader->>Loader: initPlugins(e)
    loop éå†æ‰€æœ‰æ’ä»¶
        Loader->>Plugin: accept(e)
        Plugin-->>Loader: true/false/'return'
        alt acceptè¿”å›true
            Loader->>Plugin: æ‰§è¡Œruleè§„åˆ™
            Plugin-->>Loader: æ‰§è¡Œç»“æœ
        end
    end
    Loader-->>Event: å¤„ç†å®Œæˆ
```

**è¯¦ç»†æ–‡æ¡£**: è§ä¸‹æ–¹[æ’ä»¶ç³»ç»Ÿè¯¦ç»†è¯´æ˜](#æ’ä»¶ç³»ç»Ÿè¯¦ç»†è¯´æ˜)

---

### ä»»åŠ¡å±‚ï¼ˆTaskerï¼‰

#### Tasker åº•å±‚è§„èŒƒ

æ‰€æœ‰ Tasker åº”å…·å¤‡çš„åŸºç¡€å±æ€§ï¼š

**äº‹ä»¶å¯¹è±¡åŸºç¡€å±æ€§**:
```javascript
{
  self_id: string,           // Bot ID
  tasker: string,           // Tasker ç±»å‹
  tasker_id: string,        // Tasker ID
  tasker_name: string,      // Tasker åç§°
  event_id: string,          // äº‹ä»¶ID
  time: number,              // æ—¶é—´æˆ³
  bot: BotInstance,         // Botå®ä¾‹
  user_id: string|number,    // ç”¨æˆ·ID
  sender: Object,            // å‘é€è€…ä¿¡æ¯
  reply: Function            // å›å¤æ–¹æ³•
}
```

**Tasker ç‰¹å®šå±æ€§**åº”ç”±å¢å¼ºæ’ä»¶å¤„ç†ï¼Œä¸åœ¨åº•å±‚è®¾ç½®ã€‚

#### Tasker åŠ è½½å™¨ (`TaskerLoader`)

**æ–‡ä»¶**: `src/infrastructure/tasker/loader.js`

**èŒè´£**:
- æ‰«ææ‰€æœ‰ `core/*/tasker` ç›®å½•
- åŠ¨æ€åŠ è½½ Tasker æ–‡ä»¶
- Tasker é€šè¿‡`Bot.tasker.push()`æ³¨å†Œ

#### OneBotv11 Tasker

**æ–‡ä»¶**: `core/system-Core/tasker/OneBotv11.js`

**æ ¸å¿ƒåŠŸèƒ½**:
- WebSocketæ¶ˆæ¯å¤„ç†
- äº‹ä»¶è½¬è¯‘ä¸æ ‡å‡†åŒ–
- å¯¹è±¡å°è£…ï¼ˆfriend/group/memberï¼‰

**å¯¹è±¡è®¿é—®**:
- `Bot[self_id].pickFriend(user_id)`: è·å–å¥½å‹å¯¹è±¡
- `Bot[self_id].pickGroup(group_id)`: è·å–ç¾¤å¯¹è±¡
- `Bot[self_id].pickMember(group_id, user_id)`: è·å–æˆå‘˜å¯¹è±¡

**è¯¦ç»†æ–‡æ¡£**: è§ä¸‹æ–¹[ä»»åŠ¡å±‚è¯¦ç»†è¯´æ˜](#ä»»åŠ¡å±‚è¯¦ç»†è¯´æ˜)

---

### äº‹ä»¶ç³»ç»Ÿ

#### äº‹ä»¶å‘½åè§„èŒƒ

**æ ¼å¼**: `{tasker}.{äº‹ä»¶ç±»å‹}.{å­ç±»å‹}`

**ç¤ºä¾‹**:
- `onebot.message.group.normal`: OneBotç¾¤èŠæ™®é€šæ¶ˆæ¯
- `device.message`: è®¾å¤‡æ¶ˆæ¯
- `stdin.message`: æ ‡å‡†è¾“å…¥æ¶ˆæ¯

#### äº‹ä»¶åŒ¹é…è§„åˆ™

1. **å®Œå…¨åŒ¹é…**: `plugin.event === actualEvent`
2. **é€šé…ç¬¦åŒ¹é…**: `onebot.message.*`
3. **é€šç”¨äº‹ä»¶åŒ¹é…**: `message`åŒ¹é…æ‰€æœ‰ Tasker çš„ message äº‹ä»¶
4. **å‰ç¼€åŒ¹é…**: `onebot.*`åŒ¹é…æ‰€æœ‰ OneBot äº‹ä»¶

#### äº‹ä»¶å¤„ç†æµç¨‹

```mermaid
flowchart TB
    A["Tasker è§¦å‘äº‹ä»¶<br/>Bot.em"] --> B["äº‹ä»¶ç›‘å¬å™¨æ¥æ”¶<br/>core/*/events/*.js"]
    B --> C{"äº‹ä»¶å»é‡æ£€æŸ¥"}
    C -->|å·²å­˜åœ¨| Z["è·³è¿‡å¤„ç†"]
    C -->|æ–°äº‹ä»¶| D["äº‹ä»¶æ ‡å‡†åŒ–<br/>Bot.prepareEvent"]
    D --> E["æ’ä»¶åŠ è½½å™¨å¤„ç†<br/>PluginsLoader.deal"]
    E --> F["æ‰§è¡Œ accept æ–¹æ³•<br/>å¢å¼ºæ’ä»¶æŒ‚è½½å±æ€§"]
    F --> G{"åŒ¹é…è§„åˆ™"}
    G -->|åŒ¹é…| H["æ‰§è¡Œæ’ä»¶è§„åˆ™"]
    G -->|ä¸åŒ¹é…| I["è·³è¿‡æ’ä»¶"]
    H --> J["è¿”å›ç»“æœ"]
    I --> J
    
    style A fill:#E6F3FF
    style E fill:#FFE6CC
    style H fill:#90EE90
    style Z fill:#FFB6C1
```

#### äº‹ä»¶ç›‘å¬å™¨å¼€å‘

**æ–‡ä»¶ä½ç½®**: `core/my-core/events/mytasker.js`

**åŸºæœ¬ç»“æ„**:
```javascript
import EventListenerBase from '#infrastructure/listener/base.js'

export default class MyTaskerEvent extends EventListenerBase {
  constructor() {
    super('mytasker')
  }

  async init() {
    Bot.on('mytasker.message', (e) => this.handleEvent(e, 'mytasker.message'))
  }

  async handleEvent(e, eventType) {
    // äº‹ä»¶å»é‡
    // è®¾ç½®åŸºç¡€å±æ€§
    // è°ƒç”¨plugins.deal(e)
  }
}
```

**è¯¦ç»†æ–‡æ¡£**: è§ä¸‹æ–¹[äº‹ä»¶ç³»ç»Ÿè¯¦ç»†è¯´æ˜](#äº‹ä»¶ç³»ç»Ÿè¯¦ç»†è¯´æ˜)

---

### HTTP/APIå±‚

#### HTTPä¸šåŠ¡å±‚

**æ–‡ä»¶**: `src/utils/http-business.js`

**åŠŸèƒ½**ï¼š
- **é‡å®šå‘ç®¡ç†**ï¼šæ”¯æŒ301/302/307/308é‡å®šå‘ï¼Œé€šé…ç¬¦åŒ¹é…ï¼Œæ¡ä»¶é‡å®šå‘
- **CDNæ”¯æŒ**ï¼šé™æ€èµ„æºCDNå›æºã€ç¼“å­˜æ§åˆ¶ã€CDNå¤´éƒ¨å¤„ç†
- **åå‘ä»£ç†å¢å¼º**ï¼šè´Ÿè½½å‡è¡¡ï¼ˆè½®è¯¢/åŠ æƒ/æœ€å°‘è¿æ¥ï¼‰ã€å¥åº·æ£€æŸ¥ã€æ•…éšœè½¬ç§»

**è¯¦ç»†æ–‡æ¡£**: [`docs/http-business-layer.md`](http-business-layer.md)

#### HTTP APIåŸºç±» (`HttpApi`)

**æ–‡ä»¶**: `src/infrastructure/http/http.js`

**ä½¿ç”¨æ–¹å¼**:
```javascript
// core/my-core/http/example.js
export default {
  name: 'example-api',
  routes: [
    {
      method: 'GET',
      path: '/api/example/ping',
      handler: async (req, res, Bot) => {
        res.json({ success: true })
      }
    }
  ],
  ws: {
    '/ws/example': async (conn, req, Bot) => {
      // WebSocketå¤„ç†
    }
  }
}
```

#### APIåŠ è½½å™¨ (`ApiLoader`)

**æ–‡ä»¶**: `src/infrastructure/http/loader.js`

**åŠ è½½æµç¨‹**:

```mermaid
flowchart TB
    A["ApiLoader.load"] --> B["æ‰«ææ‰€æœ‰core/*/httpç›®å½•"]
    B --> C["åŠ è½½APIæ¨¡å—"]
    C --> D["æŒ‰priorityæ’åº"]
    D --> E["æ³¨å†ŒHTTPè·¯ç”±"]
    E --> F["æ³¨å†ŒWebSocket"]
    F --> G["å¯ç”¨çƒ­é‡è½½ç›‘å¬"]
    G --> H["APIå¯ç”¨"]
    
    style A fill:#E6F3FF
    style D fill:#FFE6CC
    style H fill:#90EE90
```

**åŠŸèƒ½**:
- è‡ªåŠ¨æ‰«ææ‰€æœ‰ `core/*/http` ç›®å½•
- æŒ‰ä¼˜å…ˆçº§æ’åº
- æ³¨å†Œè·¯ç”±å’ŒWebSocket
- æ”¯æŒçƒ­é‡è½½

**è¯¦ç»†æ–‡æ¡£**: è§ä¸‹æ–¹[HTTP/APIå±‚è¯¦ç»†è¯´æ˜](#httpapiå±‚è¯¦ç»†è¯´æ˜)

---

### AIå·¥ä½œæµ

#### AIStreamåŸºç±»

**æ–‡ä»¶**: `src/infrastructure/aistream/aistream.js`

**æ ¸å¿ƒåŠŸèƒ½**:
- Chat Completionè°ƒç”¨
- Embeddingç”Ÿæˆä¸æ£€ç´¢
- å‡½æ•°è°ƒç”¨ï¼ˆFunction Callingï¼‰
- ä¸Šä¸‹æ–‡å¢å¼º

**ä½¿ç”¨æ–¹å¼**:
```javascript
// åœ¨æ’ä»¶ä¸­
const stream = this.getStream('chat')
const reply = await stream.process(this.e, question, config)
await this.reply(reply)
```

**å·¥ä½œæµå¤„ç†æµç¨‹**:

```mermaid
flowchart LR
    A["æ’ä»¶è°ƒç”¨process"] --> B["æ„å»ºä¸Šä¸‹æ–‡"]
    B --> C["è°ƒç”¨LLM"]
    C --> D{"æ˜¯å¦æœ‰å‡½æ•°è°ƒç”¨"}
    D -->|æ˜¯| E["æ‰§è¡Œå‡½æ•°"]
    D -->|å¦| F["è¿”å›å“åº”"]
    E --> G["å‡½æ•°ç»“æœåˆå¹¶åˆ°ä¸Šä¸‹æ–‡"]
    G --> C
    
    style A fill:#E6F3FF
    style C fill:#FFE6CC
    style E fill:#90EE90
    style F fill:#87CEEB
```

**æä¾›å•†æ”¯æŒ**:
- `generic`: OpenAIå…¼å®¹æ¥å£ï¼ˆé»˜è®¤ï¼‰
- `volcengine`: ç«å±±å¼•æ“è±†åŒ…

**ç›¸å…³æ–‡æ¡£**:
- **[å·¥ä½œæµç³»ç»Ÿå®Œæ•´æ–‡æ¡£](å·¥ä½œæµç³»ç»Ÿå®Œæ•´æ–‡æ¡£.md)** - å·¥ä½œæµç³»ç»Ÿå®Œæ•´æ–‡æ¡£ï¼ˆæ¨èï¼‰
- **[å¤æ‚ä»»åŠ¡ç¤ºä¾‹](workflow-complex-task-example.md)** - å¤æ‚ä»»åŠ¡å®Œæ•´è°ƒç”¨æµç¨‹æ¨¡æ‹Ÿ
- **[è®°å¿†ç³»ç»Ÿæ–‡æ¡£](workflow-memory-system.md)** - å·¥ä½œæµè®°å¿†ç³»ç»Ÿè¯¦ç»†æ–‡æ¡£
- **[MCPå®Œæ•´æŒ‡å—](mcp-guide.md)** - MCPå·¥å…·æ³¨å†Œä¸è¿æ¥

**è¯¦ç»†æ–‡æ¡£**: è§ä¸‹æ–¹[AIå·¥ä½œæµè¯¦ç»†è¯´æ˜](#aiå·¥ä½œæµè¯¦ç»†è¯´æ˜)

---

### é…ç½®ç³»ç»Ÿ

#### ConfigBaseåŸºç±»

**æ–‡ä»¶**: `src/infrastructure/commonconfig/commonconfig.js`

**é‡è¦è¯´æ˜**ï¼š
- `commonconfig` æ˜¯ç›®å½•åï¼ˆ`core/*/commonconfig/`ï¼‰ï¼Œç”¨äºå­˜æ”¾é…ç½®ç®¡ç†ç±»
- çœŸæ­£çš„åŸºç±»æ˜¯ `ConfigBase`ï¼Œé…ç½®ç±»éœ€è¦ç»§æ‰¿æ­¤åŸºç±»

**åŠŸèƒ½**:
- YAML/JSONè¯»å†™
- å¤šæ–‡ä»¶é…ç½®æ”¯æŒï¼ˆä¸€ä¸ªé…ç½®åŒ…å«å¤šä¸ªå­æ–‡ä»¶ï¼‰
- è·¯å¾„æ“ä½œï¼ˆget/set/deleteï¼‰
- é…ç½®æ ¡éªŒ
- è‡ªåŠ¨å¤‡ä»½

**ä½¿ç”¨æ–¹å¼**:
```javascript
// é…ç½®ç±»ç»§æ‰¿ ConfigBase
import ConfigBase from '#infrastructure/commonconfig/commonconfig.js';

export default class MyConfig extends ConfigBase {
  constructor() {
    super({
      name: 'myconfig',
      filePath: 'config/myconfig.yaml',
      // ...
    });
  }
}

// ä½¿ç”¨
const config = new MyConfig();
const data = await config.read();
await config.set('server.server.port', 8080);
```

**è¯¦ç»†æ–‡æ¡£**: è§ä¸‹æ–¹[é…ç½®ç³»ç»Ÿè¯¦ç»†è¯´æ˜](#é…ç½®ç³»ç»Ÿè¯¦ç»†è¯´æ˜)

---

### æ¸²æŸ“ç³»ç»Ÿ

#### RendereråŸºç±»

**æ–‡ä»¶**: `src/infrastructure/renderer/Renderer.js`

**åŠŸèƒ½**:
- HTMLæ¨¡æ¿æ¸²æŸ“
- æ–‡ä»¶ç›‘å¬ä¸è‡ªåŠ¨é‡è½½
- é™æ€èµ„æºè·¯å¾„å¤„ç†

**ä½¿ç”¨æ–¹å¼**:
```javascript
import RendererLoader from '#infrastructure/renderer/loader.js';

const renderer = RendererLoader.getRenderer('puppeteer');
const htmlPath = await renderer.dealTpl('status', {
  tplFile: 'resources/html/status.html',
  data: { title: 'çŠ¶æ€' }
})
const img = await renderer.renderImage({ htmlPath })
```

**è¯¦ç»†æ–‡æ¡£**: è§ä¸‹æ–¹[æ¸²æŸ“ç³»ç»Ÿè¯¦ç»†è¯´æ˜](#æ¸²æŸ“ç³»ç»Ÿè¯¦ç»†è¯´æ˜)

---

### å·¥å…·ç±»

#### BotUtil

**æ–‡ä»¶**: `src/utils/botutil.js`

**ä¸»è¦åŠŸèƒ½**:
- æ—¥å¿—å°è£…ï¼ˆ`makeLog`ï¼‰
- ç¼“å­˜ç®¡ç†ï¼ˆ`cache`ã€`getMap`ï¼‰
- æ–‡ä»¶æ“ä½œï¼ˆ`readFile`ã€`writeFile`ã€`Buffer`ï¼‰
- ç½‘ç»œè¯·æ±‚ï¼ˆ`Buffer`æ”¯æŒHTTPï¼‰
- å¼‚æ­¥æ§åˆ¶ï¼ˆ`retry`ã€`batch`ã€`sleep`ï¼‰
- æ—¶é—´æ ¼å¼åŒ–ï¼ˆ`formatDate`ã€`getTimeDiff`ï¼‰

**è¯¦ç»†æ–‡æ¡£**: è§ä¸‹æ–¹[å·¥å…·ç±»è¯¦ç»†è¯´æ˜](#å·¥å…·ç±»è¯¦ç»†è¯´æ˜)

---

## å¼€å‘æŒ‡å—

> **æ‰©å±•å¼€å‘**ï¼šXRK-AGTæä¾›äº†7å¤§æ‰©å±•ç‚¹ï¼Œå¼€å‘è€…å¯ä»¥é€šè¿‡ç»§æ‰¿åŸºç±»å¿«é€Ÿæ‰©å±•åŠŸèƒ½ã€‚è¯¦è§ **[æ¡†æ¶å¯æ‰©å±•æ€§æŒ‡å—](æ¡†æ¶å¯æ‰©å±•æ€§æŒ‡å—.md)** â­ æ¨è

### æ‰©å±•å¼€å‘æµç¨‹

1. **ç¡®å®šæ‰©å±•ç±»å‹**ï¼šæ’ä»¶ã€å·¥ä½œæµã€Taskerã€äº‹ä»¶ç›‘å¬å™¨ã€HTTP APIã€æ¸²æŸ“å™¨ã€é…ç½®
2. **é€‰æ‹©å¯¹åº”åŸºç±»**ï¼š`plugin`ã€`AIStream`ã€`HttpApi`ã€`EventListener`ã€`Renderer`ã€`ConfigBase`
3. **é˜…è¯»åŸºç±»æ–‡æ¡£**ï¼šå‚è€ƒå„æ¨¡å—çš„è¯¦ç»†æ–‡æ¡£
4. **å®ç°å¿…è¦æ–¹æ³•**ï¼šç»§æ‰¿åŸºç±»ï¼Œå®ç°ä¸šåŠ¡é€»è¾‘
5. **æ”¾ç½®åˆ°å¯¹åº”ç›®å½•**ï¼š`core/*/ä¸šåŠ¡ç›®å½•/`ï¼Œæ¡†æ¶è‡ªåŠ¨åŠ è½½

**è¯¦ç»†æŒ‡å—**ï¼šè¯·å‚è€ƒ **[æ¡†æ¶å¯æ‰©å±•æ€§æŒ‡å—](æ¡†æ¶å¯æ‰©å±•æ€§æŒ‡å—.md)** ä¸­çš„å®Œæ•´æ‰©å±•ç¤ºä¾‹å’Œæœ€ä½³å®è·µã€‚

---

## è¯¦ç»†æ–‡æ¡£ç´¢å¼•

### Botä¸»ç±»è¯¦ç»†è¯´æ˜

**æ–‡ä»¶**: `docs/bot.md`

**å†…å®¹**:
- Botç±»èŒè´£ä¸ç”Ÿå‘½å‘¨æœŸ
- å…³é”®æ–¹æ³•æ¦‚è§ˆ
- ä¸å…¶å®ƒæ ¸å¿ƒå¯¹è±¡çš„å…³ç³»
- å¼€å‘ä¸æ‰©å±•å»ºè®®

### æ’ä»¶ç³»ç»Ÿè¯¦ç»†è¯´æ˜

**æ–‡ä»¶**: `docs/plugin-base.md`ã€`docs/plugins-loader.md`

**å†…å®¹**:
- æ’ä»¶åŸºç±»å®Œæ•´API
- acceptæ–¹æ³•è¯¦è§£
- ä¸Šä¸‹æ–‡ç®¡ç†
- æ’ä»¶åŠ è½½å™¨æµç¨‹
- å†·å´ä¸èŠ‚æµæœºåˆ¶

### Tasker ç³»ç»Ÿè¯¦ç»†è¯´æ˜ï¼ˆäº‹ä»¶ç”Ÿæˆå™¨/ä»»åŠ¡å±‚ï¼‰

**æ–‡ä»¶**: `docs/tasker-base-spec.md`ã€`docs/tasker-loader.md`ã€`docs/tasker-onebotv11.md`

**å†…å®¹**:
- Taskeråº•å±‚è§„èŒƒ
- TaskeråŠ è½½å™¨æœºåˆ¶
- OneBotv11 Taskerå®Œæ•´æ–‡æ¡£
- å¯¹è±¡å°è£…ä¸APIè°ƒç”¨

### äº‹ä»¶ç³»ç»Ÿè¯¦ç»†è¯´æ˜

**æ–‡ä»¶**: `docs/äº‹ä»¶ç³»ç»Ÿæ ‡å‡†åŒ–æ–‡æ¡£.md`ã€`docs/äº‹ä»¶ç›‘å¬å™¨å¼€å‘æŒ‡å—.md`

**å†…å®¹**:
- äº‹ä»¶å‘½åä¸åŒ¹é…ä¼˜å…ˆçº§ï¼ˆç²¾ç®€ç‰ˆï¼‰
- å­—æ®µè´£ä»»åˆ†ç•Œï¼šå¿…å¡«/è‡ªåŠ¨è¡¥å…¨/å¢å¼ºæ’ä»¶å­—æ®µ
- å¤„ç†æµç¨‹é€Ÿè§ˆ
- æœ€å°äº‹ä»¶ç›‘å¬å™¨æ¨¡ç‰ˆä¸å»é‡è¦ç‚¹

### HTTP/APIå±‚è¯¦ç»†è¯´æ˜

**æ–‡ä»¶**: `docs/http-api.md`ã€`docs/api-loader.md`

**å†…å®¹**:
- HttpApiåŸºç±»API
- è·¯ç”±ä¸WebSocketæ³¨å†Œ
- APIåŠ è½½å™¨æœºåˆ¶
- çƒ­é‡è½½æ”¯æŒ

### AIå·¥ä½œæµè¯¦ç»†è¯´æ˜

**ä¸»è¦æ–‡æ¡£**:
- **[`docs/å·¥ä½œæµç³»ç»Ÿå®Œæ•´æ–‡æ¡£.md`](å·¥ä½œæµç³»ç»Ÿå®Œæ•´æ–‡æ¡£.md)** - **å·¥ä½œæµç³»ç»Ÿå®Œæ•´æ–‡æ¡£** â­ æ¨è
  - ç³»ç»Ÿæ¦‚è¿°ä¸æ ¸å¿ƒæ¶æ„
  - å·¥ä½œæµæ‰§è¡Œæµç¨‹ï¼ˆç®€å•ä»»åŠ¡å’Œå¤æ‚ä»»åŠ¡ï¼‰
  - å·¥ä½œæµç®¡ç†å™¨è¯¦è§£
  - å·¥ä½œæµå¼€å‘æŒ‡å—
  - è®°å¿†ç³»ç»Ÿä¸å·¥ä½œæµåˆå¹¶æœºåˆ¶
  - MCPå·¥å…·æ³¨å†Œ
  - æœ€ä½³å®è·µä¸å¸¸è§é—®é¢˜
- **[`docs/workflow-complex-task-example.md`](workflow-complex-task-example.md)** - å¤æ‚ä»»åŠ¡å®Œæ•´è°ƒç”¨æµç¨‹æ¨¡æ‹Ÿ
- **[`docs/workflow-memory-system.md`](workflow-memory-system.md)** - å·¥ä½œæµè®°å¿†ç³»ç»Ÿè¯¦ç»†æ–‡æ¡£
- **[`docs/mcp-guide.md`](mcp-guide.md)** - MCPå®Œæ•´æŒ‡å—

**åŸºç±»æ–‡æ¡£**:
- **æ–‡ä»¶**: `docs/aistream.md`
- **å†…å®¹**:
- AIStreamåŸºç±»API
- Embeddingæä¾›å•†
- å‡½æ•°è°ƒç”¨æœºåˆ¶
- ä¸Šä¸‹æ–‡å¢å¼º

### é…ç½®ç³»ç»Ÿè¯¦ç»†è¯´æ˜

**æ–‡ä»¶**: `docs/config-base.md`

**å†…å®¹**:
- ConfigBaseåŸºç±»API
- è·¯å¾„æ“ä½œ
- é…ç½®æ ¡éªŒ
- Schemaå®šä¹‰
- å¤šæ–‡ä»¶é…ç½®ï¼ˆmultiFileï¼‰

### æ¸²æŸ“ç³»ç»Ÿè¯¦ç»†è¯´æ˜

**æ–‡ä»¶**: `docs/renderer.md`

**å†…å®¹**:
- RendereråŸºç±»API
- æ¨¡æ¿å¤„ç†
- æ–‡ä»¶ç›‘å¬
- è‡ªå®šä¹‰æ¸²æŸ“å™¨å¼€å‘

### å·¥å…·ç±»è¯¦ç»†è¯´æ˜

**æ–‡ä»¶**: `docs/botutil.md`

**å†…å®¹**:
- BotUtilå®Œæ•´API
- æ—¥å¿—ä¸å­—ç¬¦ä¸²å·¥å…·
- æ–‡ä»¶ä¸ç½‘ç»œæ“ä½œ
- å¼‚æ­¥æ§åˆ¶æ–¹æ³•

### åº”ç”¨å¼€å‘è¯¦ç»†è¯´æ˜

**æ–‡ä»¶**: `docs/app-dev.md`

**å†…å®¹**:
- å¯åŠ¨æµç¨‹è¯¦è§£
- é…ç½®ä½“ç³»è¯´æ˜
- Webæ§åˆ¶å°å¼€å‘
- å‰åç«¯åä½œ

---

## ä¸‹ä¸€æ­¥

- ğŸ“– **æ·±å…¥å­¦ä¹ **ï¼šæŸ¥çœ‹ [æ¡†æ¶å¯æ‰©å±•æ€§æŒ‡å—](æ¡†æ¶å¯æ‰©å±•æ€§æŒ‡å—.md) äº†è§£å¦‚ä½•å¼€å‘æ–° Core
- ğŸ”§ **å¼€å‘å®è·µ**ï¼šå‚è€ƒå„æ¨¡å—çš„è¯¦ç»†æ–‡æ¡£è¿›è¡Œå¼€å‘
- ğŸ’¡ **æœ€ä½³å®è·µ**ï¼šæŸ¥çœ‹ [æ¡†æ¶å¯æ‰©å±•æ€§æŒ‡å—](æ¡†æ¶å¯æ‰©å±•æ€§æŒ‡å—.md) ä¸­çš„æœ€ä½³å®è·µç« èŠ‚

---

*æœ¬æ–‡æ¡£æ•´åˆäº†æ‰€æœ‰æ ¸å¿ƒæ–‡æ¡£ï¼Œå¦‚éœ€æ›´è¯¦ç»†çš„ä¿¡æ¯ï¼Œè¯·å‚è€ƒå¯¹åº”çš„è¯¦ç»†æ–‡æ¡£ã€‚*

