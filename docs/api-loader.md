## ApiLoader æ–‡æ¡£ï¼ˆsrc/infrastructure/http/loader.jsï¼‰

> **å¯æ‰©å±•æ€§**ï¼šApiLoaderæ˜¯HTTP/APIç³»ç»Ÿçš„æ ¸å¿ƒåŠ è½½å™¨ï¼Œè‡ªåŠ¨å‘ç°å’ŒåŠ è½½æ‰€æœ‰APIæ¨¡å—ã€‚APIå¼€å‘è€…åªéœ€å°†APIæ”¾ç½®åˆ°å¯¹åº”ç›®å½•ï¼Œæ— éœ€ä»»ä½•é…ç½®ã€‚è¯¦è§ **[æ¡†æ¶å¯æ‰©å±•æ€§æŒ‡å—](æ¡†æ¶å¯æ‰©å±•æ€§æŒ‡å—.md)** â­

`ApiLoader` è´Ÿè´£ä»æ‰€æœ‰ `core/*/http` ç›®å½•åŠ¨æ€åŠ è½½æ‰€æœ‰ HTTP API æ¨¡å—ï¼Œå¹¶å®Œæˆï¼š

- API å®ä¾‹åŒ–ä¸ä¼˜å…ˆçº§æ’åºã€‚
- å°†è·¯ç”±ä¸ WebSocket å¤„ç†å™¨æ³¨å†Œåˆ° Express ä¸ Botã€‚
- ç›‘æ§ API æ–‡ä»¶å˜æ›´ï¼Œå®ç°çƒ­åŠ è½½ã€‚

### æ‰©å±•ç‰¹æ€§

- âœ… **è‡ªåŠ¨å‘ç°**ï¼šè‡ªåŠ¨æ‰«ææ‰€æœ‰ `core/*/http/` ç›®å½•ï¼ˆæ”¯æŒé€’å½’ï¼‰
- âœ… **çµæ´»å¯¼å‡º**ï¼šæ”¯æŒç±»å¯¼å‡ºå’Œå¯¹è±¡å¯¼å‡ºä¸¤ç§æ–¹å¼
- âœ… **çƒ­é‡è½½**ï¼šæ”¯æŒæ–‡ä»¶ç›‘å¬å’Œè‡ªåŠ¨é‡è½½
- âœ… **é”™è¯¯éš”ç¦»**ï¼šå•ä¸ªAPIåŠ è½½å¤±è´¥ä¸å½±å“å…¶ä»–API
- âœ… **ä¼˜å…ˆçº§æ’åº**ï¼šæ”¯æŒæŒ‰ä¼˜å…ˆçº§æ’åº

> ğŸ’¡ **å®é™…ç¤ºä¾‹**ï¼šsystem-Core æä¾›äº†10ä¸ªHTTP APIæ¨¡å—çš„å®é™…å®ç°ï¼Œå±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ ApiLoader è‡ªåŠ¨åŠ è½½å’Œç®¡ç†APIã€‚è¯¦è§ [system-Core ç‰¹æ€§æ–‡æ¡£](system-core.md#http-api-æ¨¡å—)ã€‚

---

## æ ¸å¿ƒå±æ€§

- `apis: Map<string, apiInstance>`ï¼šä»¥ç›¸å¯¹è·¯å¾„ key å­˜å‚¨æ‰€æœ‰ API å®ä¾‹ã€‚
- `priority: apiInstance[]`ï¼šæŒ‰ä¼˜å…ˆçº§æ’åºåçš„ API åˆ—è¡¨ã€‚
- `watcher: { [name: string]: FSWatcher }`ï¼šæ–‡ä»¶ç›‘è§†å™¨ã€‚
- `loaded: boolean`ï¼šæ˜¯å¦å·²ç»å®Œæˆåˆæ¬¡åŠ è½½ã€‚
- `app`ï¼šå½“å‰ Express å®ä¾‹ã€‚
- `bot`ï¼šå½“å‰ Bot å®ä¾‹ã€‚

---

## åŠ è½½æµç¨‹ï¼š`load()`

**APIåŠ è½½å®Œæ•´æµç¨‹**:

```mermaid
flowchart TB
    A["ApiLoader.load"] --> B["æ‰«ææ‰€æœ‰core/*/httpç›®å½•"]
    B --> C["getApiFilesé€’å½’æ‰«æ"]
    C --> D["æ”¶é›†.jsæ–‡ä»¶<br/>è·³è¿‡.å’Œ_å¼€å¤´"]
    D --> E["éå†æ¯ä¸ªæ–‡ä»¶"]
    E --> F["loadApiåŠ è½½å•ä¸ªAPI"]
    F --> G["ç”Ÿæˆç›¸å¯¹è·¯å¾„key"]
    G --> H{"keyæ˜¯å¦å·²å­˜åœ¨"}
    H -->|æ˜¯| I["unloadApiå¸è½½æ—§API"]
    H -->|å¦| J["æ„å»ºfile://URL"]
    I --> J
    J --> K["åŠ¨æ€å¯¼å…¥æ¨¡å—"]
    K --> L{"å¯¼å‡ºç±»å‹"}
    L -->|ç±»| M["new module.default"]
    L -->|å¯¹è±¡| N["new HttpApiåŒ…è£…"]
    M --> O["æ ¡éªŒroutesæ•°ç»„"]
    N --> O
    O --> P["ç¡®ä¿getInfoæ–¹æ³•å­˜åœ¨"]
    P --> Q["å­˜å…¥apis Map"]
    Q --> R["sortByPriorityæ’åº"]
    R --> S["è¿‡æ»¤enable=false"]
    S --> T["æŒ‰priorityæ’åº"]
    T --> U["loaded=true"]
    
    style A fill:#E6F3FF
    style F fill:#FFE6CC
    style U fill:#90EE90
```

**æ­¥éª¤è¯´æ˜**ï¼š

1. è°ƒç”¨ `paths.getCoreSubDirs('http')` è·å–æ‰€æœ‰ `core/*/http` ç›®å½•
2. è°ƒç”¨ `getApiFiles` é€’å½’æ‰«ææ¯ä¸ªç›®å½•ï¼Œæ”¶é›† `.js` æ–‡ä»¶
3. å¯¹æ¯ä¸ªæ–‡ä»¶è°ƒç”¨ `loadApi`ï¼š
   - ç”Ÿæˆç›¸å¯¹è·¯å¾„ key
   - åŠ¨æ€å¯¼å…¥æ¨¡å—å¹¶å®ä¾‹åŒ–
   - æ ¡éªŒå¹¶å­˜å…¥ `apis` Map
4. è°ƒç”¨ `sortByPriority` æ’åº
5. æ ‡è®° `loaded = true`

---

## æ³¨å†Œæµç¨‹ï¼š`register(app, bot)`

**APIæ³¨å†Œå®Œæ•´æµç¨‹**:

```mermaid
sequenceDiagram
    participant Bot as Bot.run
    participant Loader as ApiLoader
    participant Express as Express
    participant API as HttpApiå®ä¾‹
    
    Bot->>Loader: register(app, bot)
    Loader->>Loader: ä¿å­˜appå’Œbotå¼•ç”¨
    Loader->>Express: æ³¨å†Œå…¨å±€ä¸­é—´ä»¶<br/>æ³¨å…¥req.botå’Œreq.apiLoader
    loop æŒ‰ä¼˜å…ˆçº§éå†APIï¼ˆé™åºï¼‰
        Loader->>Loader: æ£€æŸ¥APIæœ‰æ•ˆæ€§<br/>æ£€æŸ¥enableçŠ¶æ€
        alt APIæœ‰æ•ˆä¸”å¯ç”¨
            Loader->>API: api.init(app, bot)
            API->>API: æŒ‚è½½å…¨å±€ä¸­é—´ä»¶
            API->>Express: registerRoutesæ³¨å†ŒHTTPè·¯ç”±
            API->>Bot: registerWebSocketHandlersæ³¨å†ŒWS
            API->>API: æ‰§è¡ŒinitHookï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            API-->>Loader: è¿”å›true
            Loader->>Loader: è®°å½•æ³¨å†Œæ—¥å¿—
        else APIæ— æ•ˆæˆ–ç¦ç”¨
            Loader->>Loader: è·³è¿‡API
        end
    end
    Loader->>Express: æ·»åŠ /api/* 404å…œåº•å¤„ç†<br/>æ’é™¤ä»£ç†è·¯ç”±
    Loader-->>Bot: æ³¨å†Œå®Œæˆ
```

**æ­¥éª¤è¯´æ˜**ï¼š

1. **ä¿å­˜å¼•ç”¨**ï¼šä¿å­˜ `app` ä¸ `bot` å¼•ç”¨åˆ° `this.app` å’Œ `this.bot`
2. **æ³¨å†Œå…¨å±€ä¸­é—´ä»¶**ï¼šæ³¨å…¥ `req.bot = bot` å’Œ `req.apiLoader = this`
3. **æŒ‰ä¼˜å…ˆçº§åˆå§‹åŒ–**ï¼šéå† `this.priority`ï¼ˆå·²æŒ‰ä¼˜å…ˆçº§é™åºæ’åºï¼‰
   - æ£€æŸ¥APIæœ‰æ•ˆæ€§ï¼ˆæ˜¯å¦ä¸ºå¯¹è±¡ï¼‰
   - æ£€æŸ¥å¯ç”¨çŠ¶æ€ï¼ˆ`api.enable !== false`ï¼‰
   - è°ƒç”¨ `api.init(app, bot)` åˆå§‹åŒ–
   - è®°å½•æ³¨å†Œæ—¥å¿—ï¼ˆåŒ…å«è·¯ç”±æ•°å’ŒWSæ•°ï¼‰
4. **404å…œåº•å¤„ç†**ï¼šæ·»åŠ  `/api/*` 404å¤„ç†ï¼Œæ’é™¤ä»£ç†è·¯ç”±ï¼ˆå¦‚ `/api/god/*`ï¼‰

**ä¼˜å…ˆçº§è¯´æ˜**ï¼š
- ä¼˜å…ˆçº§æ•°å­—è¶Šå¤§ï¼Œä¼˜å…ˆçº§è¶Šé«˜
- æŒ‰ä¼˜å…ˆçº§é™åºæ’åºï¼ˆé«˜ä¼˜å…ˆçº§åœ¨å‰ï¼‰
- ç›¸åŒä¼˜å…ˆçº§æŒ‰åŠ è½½é¡ºåº

> **é‡è¦**ï¼šæ‰€æœ‰ API è·¯ç”±éƒ½ä¼šç»è¿‡ Bot çš„è®¤è¯ä¸­é—´ä»¶ä¸é€šç”¨ä¸­é—´ä»¶æ ˆï¼Œç¡®ä¿æœ‰ç»Ÿä¸€çš„å®‰å…¨ä¸æ—¥å¿—ç­–ç•¥ã€‚API ä¸éœ€è¦è‡ªå·±å®ç°è®¤è¯é€»è¾‘ã€‚

---

## å•ä¸ª API é‡è½½ï¼š`changeApi(key)`

**APIé‡è½½æµç¨‹**:

```mermaid
flowchart TB
    A["changeApi(key)"] --> B{"APIæ˜¯å¦å­˜åœ¨"}
    B -->|å¦| C["è¿”å›false"]
    B -->|æ˜¯| D["è®°å½•é‡è½½æ—¥å¿—"]
    D --> E["loadApié‡æ–°åŠ è½½æ–‡ä»¶"]
    E --> F["sortByPriorityé‡æ–°æ’åº"]
    F --> G{"æ˜¯å¦æœ‰app/bot"}
    G -->|æ˜¯| H["è°ƒç”¨newApi.inité‡æ–°æ³¨å†Œ"]
    G -->|å¦| I["ç­‰å¾…registeræ—¶æ³¨å†Œ"]
    H --> J["è®°å½•é‡è½½æˆåŠŸ"]
    I --> J
    J --> K["è¿”å›true"]
    
    style A fill:#E6F3FF
    style E fill:#FFE6CC
    style K fill:#90EE90
    style C fill:#FFB6C1
```

**æ­¥éª¤è¯´æ˜**ï¼š

1. **æŸ¥æ‰¾API**ï¼šé€šè¿‡ key æ‰¾åˆ°æ—§ API å®ä¾‹
2. **é‡æ–°åŠ è½½**ï¼šè°ƒç”¨ `loadApi(api.filePath)` é‡æ–°åŠ è½½æ¨¡å—
3. **é‡æ–°æ’åº**ï¼šè°ƒç”¨ `sortByPriority()` è°ƒæ•´ä¼˜å…ˆçº§é¡ºåº
4. **é‡æ–°æ³¨å†Œ**ï¼šè‹¥æ–° API å­˜åœ¨ä¸”å·²ç»æœ‰ `app` å’Œ `bot`ï¼š
   - è°ƒç”¨ `newApi.init(this.app, this.bot)` é‡æ–°æ³¨å†Œè·¯ç”±å’ŒWebSocket
5. **è®°å½•æ—¥å¿—**ï¼šè¾“å‡ºé‡è½½å®Œæˆæ—¥å¿—

**ä½¿ç”¨åœºæ™¯**ï¼š
- æ–‡ä»¶å˜åŒ–è§¦å‘ï¼ˆçƒ­é‡è½½ï¼‰
- æ‰‹åŠ¨é‡è½½å•ä¸ª APIï¼ˆè°ƒè¯•æ—¶ï¼‰

**æ³¨æ„äº‹é¡¹**ï¼š
- æ—§è·¯ç”±ä¸ä¼šè‡ªåŠ¨å¸è½½ï¼Œé€šå¸¸éœ€è¦é…åˆ `Bot` é‡å¯æˆ–æ˜ç¡®è®¾è®¡å¹‚ç­‰åˆå§‹åŒ–é€»è¾‘
- é‡è½½æ—¶ç¡®ä¿ `init` æ–¹æ³•æ˜¯å¹‚ç­‰çš„ï¼ˆå¤šæ¬¡è°ƒç”¨ä¸ä¼šäº§ç”Ÿå‰¯ä½œç”¨ï¼‰
- å…¨å±€ä¸­é—´ä»¶éœ€è¦ç¡®ä¿ä¸ä¼šé‡å¤æŒ‚è½½

---

## æ–‡ä»¶ç›‘è§†ä¸çƒ­åŠ è½½ï¼š`watch(enable = true)`

**çƒ­åŠ è½½æµç¨‹**:

```mermaid
flowchart TB
    A["watchå¯ç”¨"] --> B{"enableå‚æ•°"}
    B -->|false| C["å…³é—­æ‰€æœ‰watcher<br/>æ¸…ç†èµ„æº"]
    B -->|true| D["chokidar.watchç›‘è§†core/*/http<br/>é€’å½’ç›‘è§†å­ç›®å½•"]
    D --> E["ç›‘å¬æ–‡ä»¶äº‹ä»¶"]
    E --> F{"äº‹ä»¶ç±»å‹"}
    F -->|addæ–°å¢| G["loadApiåŠ è½½æ–°API"]
    F -->|changeä¿®æ”¹| H["changeApiçƒ­é‡è½½"]
    F -->|unlinkåˆ é™¤| I["unloadApiå¸è½½API"]
    G --> J["sortByPriorityæ’åº"]
    H --> J
    I --> J
    J --> K{"æ˜¯å¦æœ‰app/bot"}
    K -->|æ˜¯| L["è°ƒç”¨initå³æ—¶æŒ‚è½½<br/>é‡æ–°æ³¨å†Œè·¯ç”±å’ŒWS"]
    K -->|å¦| M["ç­‰å¾…registeræ—¶æŒ‚è½½"]
    L --> N["çƒ­åŠ è½½å®Œæˆ"]
    M --> N
    
    style A fill:#E6F3FF
    style E fill:#FFE6CC
    style N fill:#90EE90
```

**äº‹ä»¶å¤„ç†**ï¼š

- **`add`** - æ–°å¢æ–‡ä»¶æ—¶ï¼š
  - è°ƒç”¨ `loadApi` åŠ è½½æ–°API
  - è°ƒç”¨ `sortByPriority` é‡æ–°æ’åº
  - è‹¥å·²åˆå§‹åŒ–ï¼ˆæœ‰ `app` å’Œ `bot`ï¼‰ï¼Œè°ƒç”¨ `init` å³æ—¶æŒ‚è½½
  
- **`change`** - æ–‡ä»¶ä¿®æ”¹æ—¶ï¼š
  - è°ƒç”¨ `changeApi` çƒ­é‡è½½
  - è‡ªåŠ¨é‡æ–°æ³¨å†Œè·¯ç”±å’ŒWebSocket
  
- **`unlink`** - æ–‡ä»¶åˆ é™¤æ—¶ï¼š
  - è°ƒç”¨ `unloadApi` å¸è½½API
  - è°ƒç”¨ `sortByPriority` é‡æ–°æ’åº

**æ³¨æ„äº‹é¡¹**ï¼š
- çƒ­é‡è½½æ—¶ç¡®ä¿ `init` æ–¹æ³•æ˜¯å¹‚ç­‰çš„
- å…¨å±€ä¸­é—´ä»¶éœ€è¦ç¡®ä¿ä¸ä¼šé‡å¤æŒ‚è½½
- å¤æ‚APIå»ºè®®é‡å¯è¿›ç¨‹ä»¥è·å¾—æ›´æ¸…æ™°çš„çŠ¶æ€

---

## API ä¿¡æ¯è·å–ï¼š`getApiList()` ä¸ `getApi(key)`

### `getApiList()`

éå† `this.apis`ï¼Œå¯¹æ¯ä¸ªå®ä¾‹è°ƒç”¨ `getInfo()`ï¼ˆè‹¥å­˜åœ¨ï¼‰ï¼Œå¦åˆ™æ„é€ åŸºæœ¬ä¿¡æ¯ã€‚

**è¿”å›æ ¼å¼**ï¼š
```javascript
[
  {
    name: 'example-api',
    dsc: 'ç¤ºä¾‹ API',
    priority: 100,
    routes: 2,
    ws: 1,
    enable: true,
    createTime: 1703123456789
  },
  // ...
]
```

**ä½¿ç”¨åœºæ™¯**ï¼š
- åå°ç®¡ç†é¢æ¿å±•ç¤º
- å¯¹å¤–æä¾› API æ–‡æ¡£ä¸ç»Ÿè®¡
- å‰ç«¯åŠ¨æ€ç”ŸæˆAPIåˆ—è¡¨

### `getApi(key)`

æŒ‰ key è¿”å›å¯¹åº”APIå®ä¾‹ï¼Œä¸å­˜åœ¨åˆ™è¿”å› `null`ã€‚

**å‚æ•°**ï¼š
- `key`: APIé”®åï¼ˆç›¸å¯¹è·¯å¾„ï¼Œå¦‚ `example/ping`ï¼‰

**è¿”å›å€¼**ï¼š`HttpApi` å®ä¾‹æˆ– `null`

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```javascript
const api = ApiLoader.getApi('example/ping');
if (api) {
  const info = api.getInfo();
  console.log('APIä¿¡æ¯:', info);
}
```

---

## ä½¿ç”¨å»ºè®®

### æ–°å¢ API æ¨¡å—

1. **åˆ›å»ºæ–‡ä»¶**ï¼šåœ¨ä»»æ„ `core/*/http` ç›®å½•ä¸‹åˆ›å»ºæ–°çš„ `.js` æ–‡ä»¶ï¼ˆå¦‚ `core/my-core/http/my-api.js`ï¼‰
2. **å¯¼å‡ºé…ç½®**ï¼šæŒ‰ `docs/http-api.md` ä¸­çš„æ¨èæ–¹å¼å¯¼å‡º `default`
3. **è‡ªåŠ¨åŠ è½½**ï¼š`ApiLoader` ä¼šåœ¨å¯åŠ¨æˆ–æ–‡ä»¶å˜æ›´æ—¶è‡ªåŠ¨åŠ è½½

**ç¤ºä¾‹**ï¼š
```javascript
// core/my-core/http/my-api.js
export default {
  name: 'my-api',
  dsc: 'æˆ‘çš„API',
  routes: [/* ... */]
};
```

### è°ƒè¯•è·¯ç”±é—®é¢˜

1. **æ£€æŸ¥åŠ è½½çŠ¶æ€**ï¼š
   - ç¡®è®¤ API æ˜¯å¦å‡ºç°åœ¨ `getApiList()` è¾“å‡ºä¸­
   - æŸ¥çœ‹å¯åŠ¨æ—¥å¿—ä¸­å¯¹åº” API çš„åŠ è½½ä¿¡æ¯

2. **æ£€æŸ¥æ³¨å†ŒçŠ¶æ€**ï¼š
   - æŸ¥çœ‹å¯åŠ¨æ—¥å¿—ä¸­å¯¹åº” API çš„ã€Œæ³¨å†Œè·¯ç”±ã€ä¿¡æ¯
   - æ£€æŸ¥æ˜¯å¦è¢« `enable === false` ç¦ç”¨

3. **æ£€æŸ¥è·¯ç”±é…ç½®**ï¼š
   - éªŒè¯ `method`ã€`path`ã€`handler` æ˜¯å¦å®Œæ•´
   - æ£€æŸ¥è·¯å¾„æ˜¯å¦æ­£ç¡®ï¼ˆæ³¨æ„å¤§å°å†™ï¼‰

4. **æ£€æŸ¥ä¸­é—´ä»¶**ï¼š
   - ç¡®è®¤æ˜¯å¦è¢«Botä¸­é—´ä»¶æ‹¦æˆª
   - æ£€æŸ¥è®¤è¯æ˜¯å¦é€šè¿‡

### çƒ­æ›´æ–°æ³¨æ„äº‹é¡¹

1. **å¹‚ç­‰æ€§**ï¼š
   - è‹¥ API å†…éƒ¨åœ¨ `init` ä¸­æ³¨å†Œäº†å…¨å±€ä¸­é—´ä»¶ï¼Œåº”ç¡®ä¿å¤šæ¬¡è°ƒç”¨ä¸ä¼šäº§ç”Ÿé‡å¤æŒ‚è½½
   - å¯ä»¥ä½¿ç”¨ idempotent é€»è¾‘ï¼ˆæ£€æŸ¥æ˜¯å¦å·²æ³¨å†Œï¼‰

2. **çŠ¶æ€ç®¡ç†**ï¼š
   - å¯¹äºå¤æ‚ APIï¼ˆå¦‚æ•°æ®åº“è¿æ¥ã€é•¿è¿æ¥ï¼‰ï¼Œå¿…è¦æ—¶ä»å»ºè®®é‡å¯è¿›ç¨‹
   - ç¡®ä¿é‡è½½æ—¶æ­£ç¡®æ¸…ç†èµ„æº

3. **é”™è¯¯å¤„ç†**ï¼š
   - çƒ­é‡è½½å¤±è´¥ä¸ä¼šå½±å“å…¶ä»–API
   - æŸ¥çœ‹æ—¥å¿—äº†è§£é‡è½½å¤±è´¥åŸå› 

### ä¸å·¥ä½œæµç³»ç»Ÿé›†æˆ

APIå¯ä»¥é€šè¿‡ `StreamLoader` è°ƒç”¨å·¥ä½œæµç³»ç»Ÿï¼š

```javascript
import StreamLoader from '#infrastructure/aistream/loader.js';

export default {
  name: 'ai-api',
  routes: [
    {
      method: 'POST',
      path: '/api/ai/chat',
      handler: async (req, res, bot) => {
        const stream = StreamLoader.getStream('chat');
        if (!stream) {
          return res.status(404).json({ success: false, message: 'å·¥ä½œæµæœªæ‰¾åˆ°' });
        }
        
        const e = {
          user_id: req.user?.id || 'web_user',
          msg: req.body.message,
          reply: async (msg) => {
            res.json({ success: true, response: msg });
          }
        };
        
        await stream.process(e, req.body.message, {
          enableMemory: true
        });
      }
    }
  ]
};
```

---

## ç›¸å…³æ–‡æ¡£

- **[HTTP API åŸºç±»](http-api.md)** - HttpApi åŸºç±»å®Œæ•´è¯´æ˜
- **[system-Core ç‰¹æ€§](system-core.md)** - system-Core å†…ç½®æ¨¡å—å®Œæ•´è¯´æ˜ï¼ŒåŒ…å«10ä¸ªHTTP APIæ¨¡å—çš„å®é™…ç¤ºä¾‹ â­
- **[æ¡†æ¶å¯æ‰©å±•æ€§æŒ‡å—](æ¡†æ¶å¯æ‰©å±•æ€§æŒ‡å—.md)** - æ‰©å±•å¼€å‘å®Œæ•´æŒ‡å—

---

*æœ€åæ›´æ–°ï¼š2026-01-27*