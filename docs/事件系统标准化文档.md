# äº‹ä»¶ç³»ç»Ÿæ ‡å‡†åŒ–æ–‡æ¡£

> **å¯æ‰©å±•æ€§**ï¼šäº‹ä»¶ç³»ç»Ÿæ˜¯æ¡†æ¶çš„æ ¸å¿ƒæ‰©å±•ç‚¹ä¹‹ä¸€ã€‚é€šè¿‡ç»§æ‰¿EventListenerBaseï¼Œå¼€å‘è€…å¯ä»¥å¿«é€Ÿåˆ›å»ºè‡ªå®šä¹‰äº‹ä»¶ç›‘å¬å™¨ï¼Œæ— éœ€ä¿®æ”¹åº•å±‚ä»£ç ã€‚è¯¦è§ **[æ¡†æ¶å¯æ‰©å±•æ€§æŒ‡å—](æ¡†æ¶å¯æ‰©å±•æ€§æŒ‡å—.md)** â­

æœ¬æ–‡æ¡£æ¶µç›–äº‹ä»¶ç³»ç»Ÿçš„å‘½åè§„èŒƒã€å­—æ®µè´£ä»»è¾¹ç•Œã€å¤„ç†æµç¨‹ä»¥åŠäº‹ä»¶ç›‘å¬å™¨çš„å¼€å‘æŒ‡å—ã€‚

## ğŸ“š ç›®å½•

- [å‘½åä¸åŒ¹é…](#å‘½åä¸åŒ¹é…)
- [å­—æ®µè´£ä»»è¾¹ç•Œ](#å­—æ®µè´£ä»»è¾¹ç•Œ)
- [å¤„ç†æµç¨‹é€Ÿè§ˆ](#å¤„ç†æµç¨‹é€Ÿè§ˆ)
- [åˆ›å»ºäº‹ä»¶ç›‘å¬å™¨](#åˆ›å»ºäº‹ä»¶ç›‘å¬å™¨)
- [ç›¸å…³æ–‡æ¡£](#ç›¸å…³æ–‡æ¡£)

---

## å‘½åä¸åŒ¹é…

**äº‹ä»¶å‘½åç»“æ„**:

```mermaid
flowchart TB
    A["äº‹ä»¶åç§°"] --> B{taskerå‰ç¼€}
    B --> C["onebot/device/stdin"]
    C --> D["äº‹ä»¶ç±»å‹"]
    D --> E["message/notice/request"]
    E --> F{æ˜¯å¦æœ‰sub_type?}
    F -->|æ˜¯| G["sub_type"]
    F -->|å¦| H["å®Œæ•´äº‹ä»¶å"]
    G --> H
    H --> I["ç¤ºä¾‹: onebot.message.group.normal"]
    
    style A fill:#E3F2FD,stroke:#1976D2,stroke-width:2px
    style B fill:#FFF3E0,stroke:#F57C00,stroke-width:2px
    style C fill:#E8F5E9,stroke:#388E3C,stroke-width:2px
    style D fill:#E1F5FE,stroke:#0277BD,stroke-width:2px
    style E fill:#FCE4EC,stroke:#C2185B,stroke-width:2px
    style G fill:#F3E5F5,stroke:#7B1FA2,stroke-width:2px
    style H fill:#E8F5E9,stroke:#388E3C,stroke-width:2px
    style I fill:#FFF3E0,stroke:#F57C00,stroke-width:2px
```

**åŒ¹é…ä¼˜å…ˆçº§**:

```mermaid
flowchart TB
    A["äº‹ä»¶åŒ¹é…æµç¨‹"] --> B{å®Œå…¨åŒ¹é…?}
    B -->|æ˜¯| C["æœ€é«˜ä¼˜å…ˆçº§<br/>ç²¾ç¡®åŒ¹é…"]
    B -->|å¦| D{é€šé…ç¬¦åŒ¹é…?}
    D -->|æ˜¯| E["ç¬¬äºŒä¼˜å…ˆçº§<br/>é€šé…ç¬¦åŒ¹é…"]
    D -->|å¦| F{é€šç”¨äº‹ä»¶åŒ¹é…?}
    F -->|æ˜¯| G["ç¬¬ä¸‰ä¼˜å…ˆçº§<br/>é€šç”¨äº‹ä»¶"]
    F -->|å¦| H{å‰ç¼€åŒ¹é…?}
    H -->|æ˜¯| I["ç¬¬å››ä¼˜å…ˆçº§<br/>å‰ç¼€åŒ¹é…"]
    H -->|å¦| J["ä¸åŒ¹é…<br/>è·³è¿‡æ’ä»¶"]
    
    C --> K["æ’ä»¶æ‰§è¡Œ"]
    E --> K
    G --> K
    I --> K
    
    style A fill:#E3F2FD,stroke:#1976D2,stroke-width:2px
    style C fill:#E8F5E9,stroke:#388E3C,stroke-width:2px
    style E fill:#E1F5FE,stroke:#0277BD,stroke-width:2px
    style G fill:#FFF3E0,stroke:#F57C00,stroke-width:2px
    style I fill:#FCE4EC,stroke:#C2185B,stroke-width:2px
    style J fill:#F3E5F5,stroke:#7B1FA2,stroke-width:2px
    style K fill:#E8F5E9,stroke:#388E3C,stroke-width:2px
```

**å‘½åè§„èŒƒ**ï¼š
- ç»“æ„ï¼š`{tasker}.{event_type}.{sub_type?}`ï¼Œç¤ºä¾‹ `onebot.message.group.normal`
- Tasker å‰ç¼€ï¼š`onebot` / `device` / `stdin` / è‡ªå®šä¹‰
- äº‹ä»¶ç±»å‹ï¼š`message`ã€`notice`ã€`request`ã€`device`ã€`command`
- åŒ¹é…ä¼˜å…ˆçº§ï¼šå®Œå…¨åŒ¹é… â†’ é€šé…ç¬¦ï¼ˆ`onebot.message.*`ï¼‰â†’ é€šç”¨äº‹ä»¶ï¼ˆ`message`ï¼‰â†’ å‰ç¼€ï¼ˆ`onebot.*`ï¼‰

## å­—æ®µè´£ä»»è¾¹ç•Œ

**ä¼˜åŒ–åçš„è´£ä»»åˆ’åˆ†ï¼ˆ2026å¹´1æœˆä¼˜åŒ–ï¼‰**ï¼š

- **è§¦å‘æ–¹ï¼ˆTasker / ä¸šåŠ¡æ¨¡å—ï¼‰** å¿…å¡«ï¼š  
  `tasker`ã€`post_type`ã€ç»†åˆ†å­—æ®µ (`message_type/notice_type/request_type/detail_type` å¯é€‰ `sub_type`)ã€æ ‡è¯†å­—æ®µ (`user_id/group_id/device_id`)ã€`message` æˆ– `raw_message`ã€`time`

- **TaskerBase.createEvent**ï¼ˆä»»åŠ¡å±‚ï¼‰ï¼š  
  åˆ›å»ºåŸºç¡€äº‹ä»¶å¯¹è±¡ï¼Œä½¿ç”¨ `EventNormalizer` ç»Ÿä¸€æ ‡å‡†åŒ–åŸºç¡€å­—æ®µï¼Œç¡®ä¿ `event_id` å­˜åœ¨ã€‚

- **äº‹ä»¶ç›‘å¬å™¨ï¼ˆcore/*/events/*.jsï¼‰**ï¼š  
  è´Ÿè´£å»é‡ï¼ˆ`EventListenerBase.markProcessed`ï¼‰ã€è¡¥å…¨ `event_id/self_id` çš„å…œåº•å€¼ã€æ‰“ä¸Š Tasker æ ‡è®°ï¼ˆ`markAdapter`ï¼‰ï¼Œå¹¶è°ƒç”¨ `PluginsLoader.deal(e)`ï¼Œä¸æŒ‚è½½ `friend/group/member` ç­‰å¤æ‚å¯¹è±¡ã€‚

- **PluginsLoader.normalizeEventPayload**ï¼ˆæ’ä»¶å±‚ï¼‰ï¼š  
  ä½¿ç”¨ `EventNormalizer` ç»Ÿä¸€æ ‡å‡†åŒ–äº‹ä»¶å¯¹è±¡ï¼ŒåŒ…æ‹¬åŸºç¡€å­—æ®µã€æ¶ˆæ¯å­—æ®µã€ç¾¤ç»„å­—æ®µï¼Œåˆå§‹åŒ–æ‰©å±•å­—æ®µï¼ˆ`img/video/audio`ï¼‰ã€‚

- **PluginsLoader + Bot.prepareEvent** è‡ªåŠ¨è¡¥å…¨ï¼š  
  `bot`ã€åŸºç¡€ `sender`ã€é€šç”¨ `reply` å…œåº•ã€`getSendableMedia/throttle/getEventHistory` ç­‰å·¥å…·æ–¹æ³•ã€‚

- **Tasker å¢å¼ºæ’ä»¶ï¼ˆEnhancerï¼‰** è´Ÿè´£ï¼š  
  `isGroup/isPrivate/friend/group/member/atBot` ç­‰ Tasker ç‰¹å®šå±æ€§ï¼ˆç›‘å¬å™¨å’Œåº•å±‚ Tasker ä¸è¦æå‰æŒ‚è½½ï¼Œä¿æŒäº‹ä»¶æœ€å°åŒ–ï¼Œä¾¿äºå¤ç”¨ï¼‰ã€‚

## å¤„ç†æµç¨‹é€Ÿè§ˆ

**äº‹ä»¶å¤„ç†å®Œæ•´æµç¨‹**:

```mermaid
sequenceDiagram
    participant Tasker as Tasker
    participant Bot as Bot.em
    participant Listener as äº‹ä»¶ç›‘å¬å™¨
    participant Prepare as prepareEvent
    participant Loader as PluginsLoader
    participant Enhancer as å¢å¼ºæ’ä»¶
    participant Plugin as ä¸šåŠ¡æ’ä»¶
    
    Tasker->>Bot: è§¦å‘äº‹ä»¶
    Bot->>Listener: äº‹ä»¶åˆ†å‘
    Listener->>Listener: å»é‡æ£€æŸ¥
    Listener->>Prepare: prepareEvent
    Prepare->>Prepare: å¡«å……é€šç”¨æ–¹æ³•
    Prepare->>Loader: deal(e)
    Loader->>Loader: æ ‡å‡†åŒ–äº‹ä»¶
    Loader->>Loader: å‰ç½®æ£€æŸ¥
    Loader->>Enhancer: acceptæŒ‚è½½å±æ€§
    Enhancer-->>Loader: è¿”å›true
    Loader->>Plugin: æ‰§è¡Œè§„åˆ™
    Plugin-->>Loader: å¤„ç†å®Œæˆ
```

**æ­¥éª¤è¯´æ˜ï¼ˆä¼˜åŒ–åï¼‰**ï¼š

1. **Tasker/ä¸šåŠ¡æ¨¡å—**ï¼š`TaskerBase.createEvent` åˆ›å»ºäº‹ä»¶å¯¹è±¡ï¼Œä½¿ç”¨ `EventNormalizer` æ ‡å‡†åŒ–åŸºç¡€å­—æ®µ â†’ `Bot.em(...)` è§¦å‘äº‹ä»¶
2. **äº‹ä»¶ç›‘å¬å™¨**ï¼š`EventListenerBase.markProcessed` å»é‡ â†’ `markAdapter` æ ‡è®° `tasker` ä¸ Tasker ç‰¹æ€§æ ‡å¿— â†’ è°ƒç”¨ `PluginsLoader.deal(e)`
3. **Bot.prepareEvent**ï¼šå¡«å……é€šç”¨æ–¹æ³•/æ ‡è¯†ï¼ˆ`bot/tasker_id/tasker_name/sender/reply` ç­‰ï¼‰
4. **PluginsLoader.deal**ï¼š
   - `normalizeEventPayload`ï¼šä½¿ç”¨ `EventNormalizer` ç»Ÿä¸€æ ‡å‡†åŒ–ï¼ˆåŸºç¡€/æ¶ˆæ¯/ç¾¤ç»„å­—æ®µï¼‰
   - `initEvent`ï¼šç¡®ä¿ `self_id/bot/event_id` å­˜åœ¨
   - `preCheck`ï¼šæ£€æŸ¥å¿½ç•¥è‡ªå·±ã€å…³æœºçŠ¶æ€ã€é»‘ç™½åå•ã€é™æµ
   - `dealMsg`ï¼šè§£ææ¶ˆæ¯ã€è®¾ç½®äº‹ä»¶å±æ€§ã€æ£€æŸ¥æƒé™ã€æ·»åŠ å·¥å…·æ–¹æ³•
   - `setupReply`ï¼šè®¾ç½®é€šç”¨å›å¤æ–¹æ³•
   - `runPlugins(true)`ï¼šæ‰§è¡Œæ‰©å±•æ’ä»¶ï¼ˆEnhancerï¼‰ï¼ŒæŒ‚è½½ Tasker ç‰¹å®šå±æ€§
   - `runPlugins(false)`ï¼šæ‰§è¡Œæ™®é€šæ’ä»¶ï¼Œå¤„ç†ä¸Šä¸‹æ–‡å’Œé™æµï¼Œæ‰§è¡Œè§„åˆ™åŒ¹é…
5. **æ’ä»¶**ï¼šæŒ‰ä¼˜å…ˆçº§/åŒ¹é…è§„åˆ™æ‰§è¡Œ `rule`ï¼Œå¯ä»¥è°ƒç”¨ `e.reply/Bot.callRoute/Bot.renderer/redis` ç­‰å®Œæˆä¸šåŠ¡é€»è¾‘

## æ’ä»¶ä¾§é€Ÿè®°
- è·¨ Taskerï¼š`event: 'message'`
- ç‰¹å®š Taskerï¼š`event: 'onebot.message'` / `device.message`
- é€šé…ç¬¦ï¼š`event: 'onebot.*'`ï¼ˆè°¨æ…ï¼‰

## æœ€ä½³å®è·µ

### ä»£ç ä¼˜åŒ–ï¼ˆ2026å¹´1æœˆï¼‰

- âœ… **ç»Ÿä¸€äº‹ä»¶æ ‡å‡†åŒ–**ï¼šä½¿ç”¨ `EventNormalizer` ç»Ÿä¸€å¤„ç†äº‹ä»¶å¯¹è±¡æ ‡å‡†åŒ–ï¼Œé¿å…é‡å¤ä»£ç 
- âœ… **è´£ä»»è¾¹ç•Œæ¸…æ™°**ï¼šç›‘å¬å±‚è´Ÿè´£å»é‡å’Œæ ‡è®°ï¼Œä»»åŠ¡å±‚è´Ÿè´£åˆ›å»ºå’Œæ ‡å‡†åŒ–ï¼Œæ’ä»¶å±‚è´Ÿè´£ä¸šåŠ¡å¤„ç†
- âœ… **å‡å°‘å†—ä½™åˆ¤æ–­**ï¼šä¼˜åŒ–äº† `preCheck`ã€`initPlugins`ã€`processRules` ç­‰æ–¹æ³•ï¼Œåˆ é™¤é‡å¤æ£€æŸ¥
- âœ… **çƒ­æ›´æ–°ä¼˜åŒ–**ï¼šæ”¹è¿›äº† `changePlugin` æ–¹æ³•ï¼Œæä¾›æ›´è¯¦ç»†çš„æ›´æ–°åé¦ˆ

### å¼€å‘å»ºè®®

- å‘½åä¿æŒä¸‰æ®µå¼ä¸”è¯­ä¹‰æ¸…æ™°ï¼Œé¿å…è‡ªé€ ç¼©å†™ã€‚
- å»é‡é›†åˆæœ‰ç•Œï¼ˆå»ºè®® ~1000ï¼‰å¹¶å®šæœŸæ¸…ç†ã€‚
- `accept` ä¸­å°½æ—©è¿”å›ï¼Œå‡å°‘æ— æ•ˆè§„åˆ™éå†ã€‚
- Tasker ç‰¹å®šé€»è¾‘ç»Ÿä¸€æ”¾å¢å¼ºæ’ä»¶ï¼Œä¿æŒåŸºç¡€äº‹ä»¶çº¯å‡€ã€‚
- ä½¿ç”¨ `EventNormalizer` è¿›è¡Œäº‹ä»¶æ ‡å‡†åŒ–ï¼Œè€Œä¸æ˜¯æ‰‹åŠ¨å¤„ç†å­—æ®µã€‚

---

## äº‹ä»¶ç›‘å¬å™¨å¼€å‘æŒ‡å—

### æ‰©å±•ç‰¹æ€§

- âœ… **é›¶é…ç½®æ‰©å±•**ï¼šæ”¾ç½®åˆ° `core/*/events/` ç›®å½•å³å¯è‡ªåŠ¨åŠ è½½
- âœ… **æ ‡å‡†åŒ–æ¥å£**ï¼šç»Ÿä¸€çš„äº‹ä»¶ç›‘å¬æ¥å£
- âœ… **è‡ªåŠ¨å»é‡**ï¼šåŸºç±»æä¾›å»é‡æœºåˆ¶
- âœ… **äº‹ä»¶åˆ†å‘**ï¼šè‡ªåŠ¨åˆ†å‘åˆ°æ’ä»¶ç³»ç»Ÿ

### å¼€å‘æµç¨‹

**äº‹ä»¶ç›‘å¬å™¨å¼€å‘æµç¨‹**:

```mermaid
flowchart TB
    A["åˆ›å»ºäº‹ä»¶ç›‘å¬å™¨ç±»<br/>core/*/events/my-listener.js"] --> B["ç»§æ‰¿EventListenerBase<br/>import EventListenerBase"]
    B --> C["å®ç°initæ–¹æ³•<br/>æ³¨å†Œäº‹ä»¶ç›‘å¬"]
    C --> D["æ³¨å†Œäº‹ä»¶ç›‘å¬<br/>Bot.on('event.type', handler)"]
    D --> E["å®ç°handleEventæ–¹æ³•<br/>å¤„ç†äº‹ä»¶é€»è¾‘"]
    E --> F["markProcessedå»é‡æ£€æŸ¥<br/>åŸºäºevent_id"]
    F --> G{"æ˜¯å¦å·²å¤„ç†è¿‡?<br/>å»é‡æ£€æŸ¥"}
    G -->|é€šè¿‡| H["markAdapteræ ‡è®°<br/>æ ‡è®°taskerç‰¹æ€§"]
    G -->|å¤±è´¥| I["âŒ è·³è¿‡å¤„ç†<br/>äº‹ä»¶å·²å¤„ç†"]
    H --> J["è°ƒç”¨plugins.deal(e)<br/>åˆ†å‘åˆ°æ’ä»¶ç³»ç»Ÿ"]
    J --> K["âœ… äº‹ä»¶å¤„ç†å®Œæˆ"]
    
    style A fill:#E6F3FF,stroke:#7AA7D9,stroke-width:2px
    style B fill:#FFE6CC,stroke:#D9A35D
    style C fill:#E8F8E8,stroke:#6CB46C
    style D fill:#E6F0FF,stroke:#7B8ED9
    style E fill:#FFE6F0,stroke:#D97BAF
    style F fill:#F3E6FF,stroke:#A57BD9
    style G fill:#FFD700,stroke:#C49A00
    style H fill:#87CEEB,stroke:#5A9FD4
    style I fill:#FF6B6B,stroke:#C92A2A
    style J fill:#90EE90,stroke:#6CB46C
    style K fill:#90EE90,stroke:#6CB46C,stroke-width:2px
```

### ä»£ç æ¨¡æ¿

```javascript
import PluginsLoader from '#infrastructure/plugins/loader.js'
import EventListenerBase from '#infrastructure/listener/base.js'

export default class MyTaskerEvent extends EventListenerBase {
  constructor() {
    super('mytasker')
  }

  async init() {
    Bot.on('mytasker.message', (e) => this.handleEvent(e, 'mytasker.message'))
    Bot.on('mytasker.notice', (e) => this.handleEvent(e, 'mytasker.notice'))
    Bot.on('mytasker.request', (e) => this.handleEvent(e, 'mytasker.request'))
  }

  async handleEvent(e, eventType) {
    // ä½¿ç”¨åŸºç±»çš„å»é‡å’Œæ ‡è®°æ–¹æ³•
    if (!this.markProcessed(e)) {
      return
    }
    
    // æ ‡è®° Tasker ç‰¹æ€§
    this.markAdapter(e, 'mytasker')

    // Tasker ç‰¹å®šå±æ€§è¯·åœ¨å¢å¼ºæ’ä»¶é‡ŒæŒ‚è½½
    await this.plugins.deal(e)
  }
}
```

### Tasker è§¦å‘ç¤ºä¾‹

```javascript
Bot.em('mytasker.message', {
  event_id: `mytasker_${Date.now()}_${Math.random()}`,
  user_id: '123456',
  post_type: 'message',
  message_type: 'private',
  message: [{ type: 'text', text: 'Hello' }]
})
```

### æ³¨æ„äº‹é¡¹

- **å¿…é¡»å»é‡**ï¼šåŸºäº `event_id` çš„æœ‰ç•Œ Setï¼Œå»ºè®®å¤§å° ~1000
- **åªè¡¥å…¨åŸºç¡€å­—æ®µ**ï¼šTasker ç‰¹å®šå±æ€§äº¤ç»™å¢å¼ºæ’ä»¶
- **é”™è¯¯å¤„ç†**ï¼štry-catch è®°å½•é”™è¯¯ï¼Œä¸è¦é˜»å¡å…¶å®ƒäº‹ä»¶
- **å†…å­˜ç®¡ç†**ï¼šå®šæœŸæ¸…ç†å»é‡é›†åˆï¼Œä¿æŒå¸¸é©»è¿›ç¨‹å†…å­˜ç¨³å®š

### å‚è€ƒç¤ºä¾‹

- `core/system-Core/events/onebot.js`
- `core/system-Core/events/device.js`
- `core/system-Core/events/stdin.js`

---

## ç›¸å…³æ–‡æ¡£

- [æ’ä»¶åŸºç±»æ–‡æ¡£](plugin-base.md) - æ’ä»¶å¼€å‘è¯¦ç»†è¯´æ˜
- [æ’ä»¶åŠ è½½å™¨æ–‡æ¡£](plugins-loader.md) - æ’ä»¶åŒ¹é…ä¸æ‰§è¡Œç»†èŠ‚
- [æ¡†æ¶å¯æ‰©å±•æ€§æŒ‡å—](æ¡†æ¶å¯æ‰©å±•æ€§æŒ‡å—.md) - å®Œæ•´çš„æ‰©å±•æŒ‡å—

