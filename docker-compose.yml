version: '3.8'

services:
  xrk-agt:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: xrk-agt
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - NODE_OPTIONS=--no-warnings --no-deprecation
      # 通过环境变量指定服务器端口，可通过 docker-compose.yml 或 .env 文件修改
      - XRK_SERVER_PORT=${XRK_SERVER_PORT:-8080}
    healthcheck:
      # 健康检查使用环境变量指定的端口（由entrypoint脚本设置）
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:${XRK_SERVER_PORT:-8080}/health || exit 1"]
      interval: 30s
      timeout: 10s
      start_period: 40s
      retries: 3
    ports:
      # 主服务端口（可通过环境变量XRK_SERVER_PORT修改，默认8080）
      # 注意：修改端口时需要同时修改端口映射和环境变量，确保两者一致
      # 如需使用其他端口，请修改下面的端口映射，例如: "3000:3000"
      - "8080:8080"
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
      - ./config:/app/config
      - ./resources:/app/resources
    networks:
      - xrk-network
    depends_on:
      - redis
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2048M
        reservations:
          cpus: '0.5'
          memory: 512M

  redis:
    image: redis:7-alpine
    container_name: xrk-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis-data:/data
    networks:
      - xrk-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M

networks:
  xrk-network:
    driver: bridge

volumes:
  redis-data:
